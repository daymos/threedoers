
extends ../base

block title
  |  Your Design Project

block body
  div
      -function prettyDate(dateString){
      -var date = new Date(dateString);
      -var d = date.getDate();
      -var monthNames = [ "Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ];
      -var m = monthNames[date.getMonth()];
      -var y = date.getFullYear();
      -var h = date.getHours()
      -var mm = date.getMinutes()
      -return d+'/'+m+'/'+y+' at '+h+':'+mm;
      -}
    .container
      -if (user.filemanager == 'accepted')
          .row
              .col-md-6
                  .back-link
                      a(href='/design/jobs')
                          img(src='/img/return_to_jobs.png')
                          | Return to jobs available
      .section.primary
          .row
            .col-md-6
              h1#title.page-header.text-ellipsis(data-type="text", data-url="/filemanager/project/title/#{project.id}", data-title="Enter the Title") #{ project.title }
            .col-md-6.margin-header-10
                h2.subtitle-upload Status: #{project.humanizedStatus()}
          .row.margin-header-10
              .col-md-6
                  p.subtitle-color.h4 Description:
                    p#description(data-type="text", data-url="/filemanager/project/description/#{project.id}", data-title="Enter the description").long-text #{ project.description }
              .col-md-6

                .download-link
                    if project.resources.length>0
                        each val, index in project.resources
                            - var n=index
                            p
                                a(href="/"+val)
                                    img(src='/img/icon_download.png')
                                    |  Resource #{++n}
      .section.primary
          .row



             - if (project.status<=statuses.PREACCEPTED[0])
                -if (user.id==project.creator)
                     - if (project.proposal.length == 0 )
                              p.info-3d There is not any proposal yet for this project.
                     - else
                              p.info-3d Proposals:
                                each prop, index in project.proposal
                                    article.tile.col-md-4.margin-top-10
                                        hearder
                                        |Proposal from #{prop.username}
                                        p
                                        |Estimate time #{prop.hour}
                                        p
                                        |Hourly cost   #{prop.cost}
                                        footer
                                         form(action="/design/proposal/review/#{prop._id}", method="post")
                                             input(type="hidden", name="project_id", value="#{project._id}")
                                             input(type="submit",value="Accept this proposal").btn.btn-default.no-margin
                - else
                    each prop, index in project.proposal
                        -if (prop.creator== user.id)
                            p.info-ed Your proposal:
                                p Estimate time #{prop.hour}
                                p Hourly cost #{prop.cost}
                            .row
                                .col-md-3.col-sm-6
                                    a#accept.btn.btn-lg.btn-default.btn-goto(href='/design/accept/#{project.id}')
                                        span ACCEPT
                                            br
                                            | THIS WORK
                                    br
                                    br
                                    br
                                .col-md-3.col-md-offset-1.col-sm-6
                                    a#deny.btn.btn-lg.btn-red.btn-goto(href='/design/deny/#{project.id}')
                                        span DENY
                                            br
                                            | THIS WORK
                                br

             -if (project.status>=statuses.ACCEPTED[0])
                .col-md-6
                    -if (designSessions.length==0)
                        p.info-3d The work is not started (no session recorderd)
                    -else
                        p.info-3d Until now #{project_total_time_logged} are logged

                        each session, index in designSessions
                                div(data-ride="carousel")#session-carouse-#{index}.carousel.slide
                                    div(role="listbox").carousel-inner
                                    each screen,innerIndex in session
                                        div(class=(index==0?"active item":"item"))
                                            img(src="#{screen.path}",alt="#{screen.session_date_stamp}")
                                    a(href="#session-carouse-#{index}",role='button',data-slide='prev').left.carousel-control
                                        span(aria-hidden='true').glyphicon.glyphicon-chevron-left
                                        span.sr-only Previous
                                    a(href="#session-carouse-#{index}",role='button',data-slide='prev').rigth.carousel-control
                                        span(aria-hidden='true').glyphicon.glyphicon-chevron-right
                                        span.sr-only Next
                .col-md-6
                    .printer-properties
                        -var tot =project.order.preAmount * project.order.preHourly
                        h4 Price
                            p   EURO
                            if user.id == project.order.designer
                                strong 3Doers: #{project.order.businessPayment} EURO
                                br
                                strong You: #{project.order.printerPayment} EURO
                            else
                                strong #{tot} EURO



  - if (user.filemanager == 'accepted' && project.status == statuses.PREACCEPTED[0])
    br
    br
    br
    div
      .container
        .row


  - if (project.status == statuses.ACCEPTED[0] && user.id == project.designer)
    .section.orange
      .container
        h1.h1-alert-payment
          span WAIT FOR THE PAYMENT YOU'LL
            br
            | RECIVE A CONFIRMATION EMAIL
          img(src='/img/alert_payment.png', alt='')

  - if (project.status == statuses.ACCEPTED[0] && user.id == project.user)
    .section.blue
      .container
        form#hidden-pay-form(action="/design/project/pay/#{project.id}", method="post")
          h1.h1-blue-alert
            | YOUR REVIEW REQUEST HAS
            br
            | BEEN ACCEPTED
          br
          button.btn.btn-lg.btn-white.btn-small(type='submit')
            span PAGA

          input(type='hidden', name='_csrf', value=csrfToken)

  - if (project.status == statuses.PAID[0] && user.id == project.filemanager)
    .section.blue
      .container
        h1.h1-alert-payment
          span PAYMENT DONE
            br
            | YOU CAN START THE REVISION
            br
            br
            button.btn.btn-lg.btn-white.btn-small#upload-reviewed-file
              span UPLOAD FILE

  - if (project.status >= statuses.PREACCEPTED[0])  // if project was accepted
      br
      br
      br
      .container
        .row
          .col-md-7
            .comment-title
              img(src='/img/icons_comment_2.png', alt='')
              h1.page-title
                span Comments Here
              h1.page-title
                span For Your Project
        br
        br
        br
        .row
          .col-md-12#comment-list
              - for comment in project.comments
                - var myclass=(user.username===comment.username ? 'mine-chat':'other-chat')
                  div(class=myclass).media
                      a.pull-left(href='#')
                          img.media-object(src='/#{comment.photo}', alt='', width='78', height='78')
                      .media-body
                       p
                          | #{comment.content}
                      .media-meta
                          | by&nbsp;
                          span.author #{comment.username==user.username?"you":comment.username}&nbsp;
                          | at&nbsp;
                          span.date #{prettyDate(comment.createdAt)}
      br
      .section.primary
          .container
              .row
                  .col-md-10.col-sm-10
                      textarea#comment-text.comment.form-control(rows=6)
                  .col-md-2.col-sm-2
                      button.btn.btn-lg.btn-default.btn-goto#comment-button
                          span SEND

  br
  br
  br

block extra-headers
  meta(name="csrf-token", content="#{csrfToken}")

block scripts
  script(type='text/javascript', src='/vendor/jquery.jeditable.js')
  script(src='/vendor/jquery.ajaxupload.js')
  script(type='text/javascript', src='/js/views/design_project_detail.js')
  script.
    var project = {
      id: "#{project._id}",
      //filename: "#{project.file}",
      //orderPrice: #{project.order?project.order.price:0},
      //hasImage: #{project.image?true:false}
    };
    $(document).ready(
      function() {
        $('#deny, #accept').click(
          function(event) {
            console.log("js figo");
            event.preventDefault();
            $.post($(this).attr('href'), function(){location.reload();})
          }
        );
      }
    );


