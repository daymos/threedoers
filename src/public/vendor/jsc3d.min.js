var JSC3D=JSC3D||{};JSC3D.Viewer=function(e,t){if(t)this.params={SceneUrl:t.SceneUrl||"",InitRotationX:t.InitRotationX||0,InitRotationY:t.InitRotationY||0,InitRotationZ:t.InitRotationZ||0,ModelColor:t.ModelColor||"#caa618",BackgroundColor1:t.BackgroundColor1||"#ffffff",BackgroundColor2:t.BackgroundColor2||"#383840",BackgroundImageUrl:t.BackgroundImageUrl||"",Background:t.Background||"on",RenderMode:t.RenderMode||"flat",Definition:t.Definition||"standard",MipMapping:t.MipMapping||"off",CreaseAngle:t.CreaseAngle||-180,SphereMapUrl:t.SphereMapUrl||"",ProgressBar:t.ProgressBar||"on",Renderer:t.Renderer||"",LocalBuffers:t.LocalBuffers||"retain"};else this.params={SceneUrl:"",InitRotationX:0,InitRotationY:0,InitRotationZ:0,ModelColor:"#caa618",BackgroundColor1:"#ffffff",BackgroundColor2:"#383840",BackgroundImageUrl:"",Background:"on",RenderMode:"flat",Definition:"standard",MipMapping:"off",CreaseAngle:-180,SphereMapUrl:"",ProgressBar:"on",Renderer:"",LocalBuffers:"retain"};this.canvas=e;this.ctx2d=null;this.canvasData=null;this.bkgColorBuffer=null;this.colorBuffer=null;this.zBuffer=null;this.selectionBuffer=null;this.frameWidth=e.width;this.frameHeight=e.height;this.scene=null;this.defaultMaterial=null;this.sphereMap=null;this.isLoaded=false;this.isFailed=false;this.abortUnfinishedLoadingFn=null;this.needUpdate=false;this.needRepaint=false;this.initRotX=0;this.initRotY=0;this.initRotZ=0;this.zoomFactor=1;this.panning=[0,0];this.rotMatrix=new JSC3D.Matrix3x4;this.transformMatrix=new JSC3D.Matrix3x4;this.sceneUrl="";this.modelColor=13280792;this.bkgColor1=16777215;this.bkgColor2=3684416;this.bkgImageUrl="";this.bkgImage=null;this.isBackgroundOn=true;this.renderMode="flat";this.definition="standard";this.isMipMappingOn=false;this.creaseAngle=-180;this.sphereMapUrl="";this.showProgressBar=true;this.buttonStates={};this.keyStates={};this.mouseX=0;this.mouseY=0;this.mouseDownX=-1;this.mouseDownY=-1;this.isTouchHeld=false;this.baseZoomFactor=1;this.suppressDraggingRotation=false;this.onloadingstarted=null;this.onloadingcomplete=null;this.onloadingprogress=null;this.onloadingaborted=null;this.onloadingerror=null;this.onmousedown=null;this.onmouseup=null;this.onmousemove=null;this.onmousewheel=null;this.onmouseclick=null;this.beforeupdate=null;this.afterupdate=null;this.mouseUsage="default";this.isDefaultInputHandlerEnabled=true;this.progressFrame=null;this.progressRectangle=null;this.messagePanel=null;this.webglBackend=null;var n=this;if(!JSC3D.PlatformInfo.isTouchDevice){this.canvas.addEventListener("mousedown",function(e){n.mouseDownHandler(e)},false);this.canvas.addEventListener("mouseup",function(e){n.mouseUpHandler(e)},false);this.canvas.addEventListener("mousemove",function(e){n.mouseMoveHandler(e)},false);this.canvas.addEventListener(JSC3D.PlatformInfo.browser=="firefox"?"DOMMouseScroll":"mousewheel",function(e){n.mouseWheelHandler(e)},false);document.addEventListener("keydown",function(e){n.keyDownHandler(e)},false);document.addEventListener("keyup",function(e){n.keyUpHandler(e)},false)}else if(JSC3D.Hammer){JSC3D.Hammer(this.canvas).on("touch release hold drag pinch transformend",function(e){n.gestureHandler(e)})}else{this.canvas.addEventListener("touchstart",function(e){n.touchStartHandler(e)},false);this.canvas.addEventListener("touchend",function(e){n.touchEndHandler(e)},false);this.canvas.addEventListener("touchmove",function(e){n.touchMoveHandler(e)},false)}};JSC3D.Viewer.prototype.setParameter=function(e,t){this.params[e]=t};JSC3D.Viewer.prototype.init=function(){this.sceneUrl=this.params["SceneUrl"];this.initRotX=parseFloat(this.params["InitRotationX"]);this.initRotY=parseFloat(this.params["InitRotationY"]);this.initRotZ=parseFloat(this.params["InitRotationZ"]);this.modelColor=parseInt("0x"+this.params["ModelColor"].substring(1));this.bkgColor1=parseInt("0x"+this.params["BackgroundColor1"].substring(1));this.bkgColor2=parseInt("0x"+this.params["BackgroundColor2"].substring(1));this.bkgImageUrl=this.params["BackgroundImageUrl"];this.isBackgroundOn=this.params["Background"].toLowerCase()=="on";this.renderMode=this.params["RenderMode"].toLowerCase();this.definition=this.params["Definition"].toLowerCase();this.creaseAngle=parseFloat(this.params["CreaseAngle"]);this.isMipMappingOn=this.params["MipMapping"].toLowerCase()=="on";this.sphereMapUrl=this.params["SphereMapUrl"];this.showProgressBar=this.params["ProgressBar"].toLowerCase()=="on";this.useWebGL=this.params["Renderer"].toLowerCase()=="webgl";this.releaseLocalBuffers=this.params["LocalBuffers"].toLowerCase()=="release";if(this.useWebGL&&JSC3D.PlatformInfo.supportWebGL&&JSC3D.WebGLRenderBackend){try{this.webglBackend=new JSC3D.WebGLRenderBackend(this.canvas,this.releaseLocalBuffers)}catch(e){}}if(!this.webglBackend){if(this.useWebGL){if(JSC3D.console)JSC3D.console.logWarning("WebGL is not available. Software rendering is enabled instead.")}try{this.ctx2d=this.canvas.getContext("2d");this.canvasData=this.ctx2d.getImageData(0,0,this.canvas.width,this.canvas.height)}catch(e){this.ctx2d=null;this.canvasData=null}}if(this.canvas.width<=2||this.canvas.height<=2)this.definition="standard";switch(this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2);this.frameHeight=~~((this.canvas.height+1)/2);break;case"high":this.frameWidth=this.canvas.width*2;this.frameHeight=this.canvas.height*2;break;case"standard":default:this.frameWidth=this.canvas.width;this.frameHeight=this.canvas.height;break}this.zoomFactor=1;this.panning=[0,0];this.rotMatrix.identity();this.transformMatrix.identity();this.isLoaded=false;this.isFailed=false;this.needUpdate=false;this.needRepaint=false;this.scene=null;this.defaultMaterial=new JSC3D.Material("default",undefined,this.modelColor,0,true);if(!this.webglBackend){this.colorBuffer=new Array(this.frameWidth*this.frameHeight);this.zBuffer=new Array(this.frameWidth*this.frameHeight);this.selectionBuffer=new Array(this.frameWidth*this.frameHeight);this.bkgColorBuffer=new Array(this.frameWidth*this.frameHeight)}this.generateBackground();this.drawBackground();var t=this;(function n(){t.doUpdate();setTimeout(n,30)})();this.setBackgroudImageFromUrl(this.bkgImageUrl);this.loadScene();this.setSphereMapFromUrl(this.sphereMapUrl)};JSC3D.Viewer.prototype.update=function(e){if(this.isFailed)return;if(e)this.needRepaint=true;else this.needUpdate=true};JSC3D.Viewer.prototype.rotate=function(e,t,n){this.rotMatrix.rotateAboutXAxis(e);this.rotMatrix.rotateAboutYAxis(t);this.rotMatrix.rotateAboutZAxis(n)};JSC3D.Viewer.prototype.setRenderMode=function(e){this.params["RenderMode"]=e;this.renderMode=e};JSC3D.Viewer.prototype.setDefinition=function(e){if(this.canvas.width<=2||this.canvas.height<=2)e="standard";if(e==this.definition)return;this.params["Definition"]=e;this.definition=e;var t=this.frameWidth;switch(this.definition){case"low":this.frameWidth=~~((this.canvas.width+1)/2);this.frameHeight=~~((this.canvas.height+1)/2);break;case"high":this.frameWidth=this.canvas.width*2;this.frameHeight=this.canvas.height*2;break;case"standard":default:this.frameWidth=this.canvas.width;this.frameHeight=this.canvas.height;break}var n=this.frameWidth/t;this.zoomFactor*=n;this.panning[0]*=n;this.panning[1]*=n;if(this.webglBackend)return;var r=this.frameWidth*this.frameHeight;if(this.colorBuffer.length<r)this.colorBuffer=new Array(r);if(this.zBuffer.length<r)this.zBuffer=new Array(r);if(this.selectionBuffer.length<r)this.selectionBuffer=new Array(r);if(this.bkgColorBuffer.length<r)this.bkgColorBuffer=new Array(r);this.generateBackground()};JSC3D.Viewer.prototype.setBackgroudImageFromUrl=function(e){this.params["BackgroundImageUrl"]=e;this.bkgImageUrl=e;if(e==""){this.bkgImage=null;return}var t=this;var n=new Image;n.onload=function(){t.bkgImage=this;t.generateBackground()};n.crossOrigin="anonymous";n.src=encodeURI(e)};JSC3D.Viewer.prototype.setSphereMapFromUrl=function(e){this.params["SphereMapUrl"]=e;this.sphereMapUrl=e;if(e==""){this.sphereMap=null;return}var t=this;var n=new JSC3D.Texture;n.onready=function(){t.sphereMap=n;t.update()};n.createFromUrl(this.sphereMapUrl)};JSC3D.Viewer.prototype.enableDefaultInputHandler=function(e){this.isDefaultInputHandlerEnabled=e};JSC3D.Viewer.prototype.setMouseUsage=function(e){this.mouseUsage=e};JSC3D.Viewer.prototype.isWebGLEnabled=function(){return this.webglBackend!=null};JSC3D.Viewer.prototype.replaceSceneFromUrl=function(e){this.params["SceneUrl"]=e;this.sceneUrl=e;this.isFailed=this.isLoaded=false;this.loadScene()};JSC3D.Viewer.prototype.replaceScene=function(e){this.params["SceneUrl"]="";this.sceneUrl="";this.isFailed=false;this.isLoaded=true;this.setupScene(e)};JSC3D.Viewer.prototype.resetScene=function(){var e=!this.scene||this.scene.isEmpty()?0:this.scene.aabb.lengthOfDiagonal();this.zoomFactor=e==0?1:(this.frameWidth<this.frameHeight?this.frameWidth:this.frameHeight)/e;this.panning=[0,0];this.rotMatrix.identity();this.rotMatrix.rotateAboutXAxis(this.initRotX);this.rotMatrix.rotateAboutYAxis(this.initRotY);this.rotMatrix.rotateAboutZAxis(this.initRotZ)};JSC3D.Viewer.prototype.getScene=function(){return this.scene};JSC3D.Viewer.prototype.pick=function(e,t){var n=new JSC3D.PickInfo;var r=this.canvas.getBoundingClientRect();var i=e-r.left;var s=t-r.top;n.canvasX=i;n.canvasY=s;var o=0;if(this.webglBackend){o=this.webglBackend.pick(i,s)}else{var u=i;var a=s;if(this.selectionBuffer!=null&&i>=0&&i<this.canvas.width&&s>=0&&s<this.canvas.height){switch(this.definition){case"low":u=~~(u/2);a=~~(a/2);break;case"high":u*=2;a*=2;break;case"standard":default:break}o=this.selectionBuffer[a*this.frameWidth+u];if(o>0)n.depth=this.zBuffer[a*this.frameWidth+u]}}if(o>0){var f=this.scene.getChildren();for(var l=0;l<f.length;l++){if(f[l].internalId==o){n.mesh=f[l];break}}}return n};JSC3D.Viewer.prototype.doUpdate=function(){if(this.needUpdate||this.needRepaint){if(this.beforeupdate!=null&&typeof this.beforeupdate=="function")this.beforeupdate();if(this.scene){if(this.needUpdate){this.beginScene();this.render();this.endScene()}this.paint()}else{this.drawBackground()}this.needRepaint=false;this.needUpdate=false;if(this.afterupdate!=null&&typeof this.afterupdate=="function")this.afterupdate()}};JSC3D.Viewer.prototype.paint=function(){if(this.webglBackend||!this.ctx2d)return;this.ctx2d.putImageData(this.canvasData,0,0)};JSC3D.Viewer.prototype.mouseDownHandler=function(e){if(!this.isLoaded)return;if(this.onmousedown){var t=this.pick(e.clientX,e.clientY);this.onmousedown(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;this.buttonStates[e.button]=true;this.mouseX=e.clientX;this.mouseY=e.clientY;this.mouseDownX=e.clientX;this.mouseDownY=e.clientY};JSC3D.Viewer.prototype.mouseUpHandler=function(e){if(!this.isLoaded)return;var t;if(this.onmouseup||this.onmouseclick){t=this.pick(e.clientX,e.clientY)}if(this.onmouseup){this.onmouseup(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}if(this.onmouseclick&&this.mouseDownX==e.clientX&&this.mouseDownY==e.clientY){this.onmouseclick(t.canvasX,t.canvasY,e.button,t.depth,t.mesh);this.mouseDownX=-1;this.mouseDownY=-1}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;this.buttonStates[e.button]=false};JSC3D.Viewer.prototype.mouseMoveHandler=function(e){if(!this.isLoaded)return;if(this.onmousemove){var t=this.pick(e.clientX,e.clientY);this.onmousemove(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;var n=this.buttonStates[0]==true;var r=this.keyStates[16]==true;var i=this.keyStates[17]==true;if(n){if(r&&this.mouseUsage=="default"||this.mouseUsage=="zoom"){this.zoomFactor*=this.mouseY<=e.clientY?1.04:.96}else if(i&&this.mouseUsage=="default"||this.mouseUsage=="pan"){var s=this.definition=="low"?.5:this.definition=="high"?2:1;this.panning[0]+=s*(e.clientX-this.mouseX);this.panning[1]+=s*(e.clientY-this.mouseY)}else if(this.mouseUsage=="default"||this.mouseUsage=="rotate"){var o=(e.clientY-this.mouseY)*360/this.canvas.width;var u=(e.clientX-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(o);this.rotMatrix.rotateAboutYAxis(u)}this.mouseX=e.clientX;this.mouseY=e.clientY;this.mouseDownX=-1;this.mouseDownY=-1;this.update()}};JSC3D.Viewer.prototype.mouseWheelHandler=function(e){if(!this.isLoaded)return;if(this.onmousewheel){var t=this.pick(e.clientX,e.clientY);this.onmousewheel(t.canvasX,t.canvasY,e.button,t.depth,t.mesh)}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;this.mouseDownX=-1;this.mouseDownY=-1;this.zoomFactor*=(JSC3D.PlatformInfo.browser=="firefox"?-e.detail:e.wheelDelta)<0?1.1:.91;this.update()};JSC3D.Viewer.prototype.touchStartHandler=function(e){if(!this.isLoaded)return;if(e.touches.length>0){var t=e.touches[0].clientX;var n=e.touches[0].clientY;if(this.onmousedown){var r=this.pick(t,n);this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh)}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;this.buttonStates[0]=true;this.mouseX=t;this.mouseY=n;this.mouseDownX=t;this.mouseDownY=n}};JSC3D.Viewer.prototype.touchEndHandler=function(e){if(!this.isLoaded)return;var t;if(this.onmouseup||this.onmouseclick){t=this.pick(this.mouseX,this.mouseY)}if(this.onmouseup){this.onmouseup(t.canvasX,t.canvasY,0,t.depth,t.mesh)}if(this.onmouseclick&&this.mouseDownX==e.touches[0].clientX&&this.mouseDownY==e.touches[0].clientY){this.onmouseclick(t.canvasX,t.canvasY,0,t.depth,t.mesh);this.mouseDownX=-1;this.mouseDownY=-1}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;this.buttonStates[0]=false};JSC3D.Viewer.prototype.touchMoveHandler=function(e){if(!this.isLoaded)return;if(e.touches.length>0){var t=e.touches[0].clientX;var n=e.touches[0].clientY;if(this.onmousemove){var r=this.pick(t,n);this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh)}e.preventDefault();e.stopPropagation();if(!this.isDefaultInputHandlerEnabled)return;if(this.mouseUsage=="zoom"){this.zoomFactor*=this.mouseY<=n?1.04:.96}else if(this.mouseUsage=="pan"){var i=this.definition=="low"?.5:this.definition=="high"?2:1;this.panning[0]+=i*(t-this.mouseX);this.panning[1]+=i*(n-this.mouseY)}else if(this.mouseUsage=="default"||this.mouseUsage=="rotate"){var s=(n-this.mouseY)*360/this.canvas.width;var o=(t-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(s);this.rotMatrix.rotateAboutYAxis(o)}this.mouseX=t;this.mouseY=n;this.mouseDownX=-1;this.mouseDownY=-1;this.update()}};JSC3D.Viewer.prototype.keyDownHandler=function(e){if(!this.isDefaultInputHandlerEnabled)return;this.keyStates[e.keyCode]=true};JSC3D.Viewer.prototype.keyUpHandler=function(e){if(!this.isDefaultInputHandlerEnabled)return;this.keyStates[e.keyCode]=false};JSC3D.Viewer.prototype.gestureHandler=function(e){if(!this.isLoaded)return;var t=e.gesture.center.pageX-document.body.scrollLeft;var n=e.gesture.center.pageY-document.body.scrollTop;var r=this.pick(t,n);switch(e.type){case"touch":if(this.onmousedown)this.onmousedown(r.canvasX,r.canvasY,0,r.depth,r.mesh);this.baseZoomFactor=this.zoomFactor;this.mouseX=t;this.mouseY=n;this.mouseDownX=t;this.mouseDownY=n;break;case"release":if(this.onmouseup)this.onmouseup(r.canvasX,r.canvasY,0,r.depth,r.mesh);if(this.onmouseclick&&this.mouseDownX==t&&this.mouseDownY==n)this.onmouseclick(r.canvasX,r.canvasY,0,r.depth,r.mesh);this.mouseDownX=-1;this.mouseDownY=-1;this.isTouchHeld=false;break;case"hold":this.isTouchHeld=true;this.mouseDownX=-1;this.mouseDownY=-1;break;case"drag":if(this.onmousemove)this.onmousemove(r.canvasX,r.canvasY,0,r.depth,r.mesh);if(!this.isDefaultInputHandlerEnabled)break;if(this.isTouchHeld){var i=this.definition=="low"?.5:this.definition=="high"?2:1;this.panning[0]+=i*(t-this.mouseX);this.panning[1]+=i*(n-this.mouseY)}else if(!this.suppressDraggingRotation){var s=(n-this.mouseY)*360/this.canvas.width;var o=(t-this.mouseX)*360/this.canvas.height;this.rotMatrix.rotateAboutXAxis(s);this.rotMatrix.rotateAboutYAxis(o)}this.mouseX=t;this.mouseY=n;this.mouseDownX=-1;this.mouseDownY=-1;this.update();break;case"pinch":if(this.onmousewheel)this.onmousewheel(r.canvasX,r.canvasY,0,r.depth,r.mesh);if(!this.isDefaultInputHandlerEnabled)break;this.suppressDraggingRotation=true;this.zoomFactor=this.baseZoomFactor*e.gesture.scale;this.mouseDownX=-1;this.mouseDownY=-1;this.update();break;case"transformend":var u=this;setTimeout(function(){u.suppressDraggingRotation=false},250);break;default:break}e.gesture.preventDefault();e.gesture.stopPropagation()};JSC3D.Viewer.prototype.loadScene=function(){if(this.abortUnfinishedLoadingFn)this.abortUnfinishedLoadingFn();this.scene=null;this.isLoaded=false;this.update();if(this.sceneUrl=="")return false;var e=this.sceneUrl.lastIndexOf("/");if(e==-1)e=this.sceneUrl.lastIndexOf("\\");var t=this.sceneUrl.substring(e+1);var n=t.lastIndexOf(".");if(n==-1){if(JSC3D.console)JSC3D.console.logError("Cannot get file format for the lack of file extension.");return false}var r=t.substring(n+1);var i=JSC3D.LoaderSelector.getLoader(r);if(!i){if(JSC3D.console)JSC3D.console.logError('Unsupported file format: "'+r+'".');return false}var s=this;i.onload=function(e){s.abortUnfinishedLoadingFn=null;s.setupScene(e);if(s.onloadingcomplete&&typeof s.onloadingcomplete=="function")s.onloadingcomplete()};i.onerror=function(e){s.scene=null;s.isLoaded=false;s.isFailed=true;s.abortUnfinishedLoadingFn=null;s.update();s.reportError(e);if(s.onloadingerror&&typeof s.onloadingerror=="function")s.onloadingerror(e)};i.onprogress=function(e,t){if(s.showProgressBar)s.reportProgress(e,t);if(s.onloadingprogress&&typeof s.onloadingprogress=="function")s.onloadingprogress(e,t)};i.onresource=function(e){if(e instanceof JSC3D.Texture&&s.isMipMappingOn&&!e.hasMipmap())e.generateMipmaps();s.update()};this.abortUnfinishedLoadingFn=function(){i.abort();s.abortUnfinishedLoadingFn=null;s.hideProgress();if(s.onloadingaborted&&typeof s.onloadingaborted=="function")s.onloadingaborted()};i.loadFromUrl(this.sceneUrl);if(this.onloadingstarted&&typeof this.onloadingstarted=="function")this.onloadingstarted();return true};JSC3D.Viewer.prototype.setupScene=function(e){if(this.creaseAngle>=0){var t=this.creaseAngle;e.forEachChild(function(e){e.creaseAngle=t})}e.init();if(!e.isEmpty()){var n=e.aabb.lengthOfDiagonal();var r=this.frameWidth;var i=this.frameHeight;this.zoomFactor=n==0?1:(r<i?r:i)/n;this.panning=[0,0]}this.rotMatrix.identity();this.rotMatrix.rotateAboutXAxis(this.initRotX);this.rotMatrix.rotateAboutYAxis(this.initRotY);this.rotMatrix.rotateAboutZAxis(this.initRotZ);this.scene=e;this.isLoaded=true;this.isFailed=false;this.needUpdate=false;this.needRepaint=false;this.update();this.hideProgress();this.hideError()};JSC3D.Viewer.prototype.reportProgress=function(e,t){if(!this.progressFrame){var n=this.canvas.getBoundingClientRect();var r=255-((this.bkgColor1&16711680)>>16);var i=255-((this.bkgColor1&65280)>>8);var s=255-(this.bkgColor1&255);var o="rgb("+r+","+i+","+s+")";var u=window.pageXOffset+n.left+40;var a=window.pageYOffset+n.top+n.height*.38;var f=n.width-(u-n.left)*2;var l=20;this.progressFrame=document.createElement("div");this.progressFrame.style.position="absolute";this.progressFrame.style.left=u+"px";this.progressFrame.style.top=a+"px";this.progressFrame.style.width=f+"px";this.progressFrame.style.height=l+"px";this.progressFrame.style.border="1px solid "+o;this.progressFrame.style.pointerEvents="none";document.body.appendChild(this.progressFrame);this.progressRectangle=document.createElement("div");this.progressRectangle.style.position="absolute";this.progressRectangle.style.left=u+3+"px";this.progressRectangle.style.top=a+3+"px";this.progressRectangle.style.width="0px";this.progressRectangle.style.height=l-4+"px";this.progressRectangle.style.background=o;this.progressRectangle.style.pointerEvents="none";document.body.appendChild(this.progressRectangle);if(!this.messagePanel){this.messagePanel=document.createElement("div");this.messagePanel.style.position="absolute";this.messagePanel.style.left=u+"px";this.messagePanel.style.top=a-16+"px";this.messagePanel.style.width=f+"px";this.messagePanel.style.height="14px";this.messagePanel.style.font="bold 14px Courier New";this.messagePanel.style.color=o;this.messagePanel.style.pointerEvents="none";document.body.appendChild(this.messagePanel)}}if(this.progressFrame.style.display!="block"){this.progressFrame.style.display="block";this.progressRectangle.style.display="block"}if(e&&this.messagePanel.style.display!="block")this.messagePanel.style.display="block";this.progressRectangle.style.width=(parseFloat(this.progressFrame.style.width)-4)*t+"px";this.messagePanel.innerHTML=e};JSC3D.Viewer.prototype.hideProgress=function(){if(this.progressFrame){this.messagePanel.style.display="none";this.progressFrame.style.display="none";this.progressRectangle.style.display="none"}};JSC3D.Viewer.prototype.reportError=function(e){if(!this.messagePanel){var t=this.canvas.getBoundingClientRect();var n=255-((this.bkgColor1&16711680)>>16);var r=255-((this.bkgColor1&65280)>>8);var i=255-(this.bkgColor1&255);var s="rgb("+n+","+r+","+i+")";var o=window.pageXOffset+t.left+40;var u=window.pageYOffset+t.top+t.height*.38;var a=t.width-(o-t.left)*2;var f=14;this.messagePanel=document.createElement("div");this.messagePanel.style.position="absolute";this.messagePanel.style.left=o+"px";this.messagePanel.style.top=u-16+"px";this.messagePanel.style.width=a+"px";this.messagePanel.style.height=f+"px";this.messagePanel.style.font="bold 14px Courier New";this.messagePanel.style.color=s;this.messagePanel.style.pointerEvents="none";document.body.appendChild(this.messagePanel)}if(this.progressFrame.style.display!="none"){this.progressFrame.style.display="none";this.progressRectangle.style.display="none"}if(e&&this.messagePanel.style.display!="block")this.messagePanel.style.display="block";this.messagePanel.innerHTML=e};JSC3D.Viewer.prototype.hideError=function(){if(this.messagePanel)this.messagePanel.style.display="none"};JSC3D.Viewer.prototype.generateBackground=function(){if(this.webglBackend){if(this.bkgImage)this.webglBackend.setBackgroundImage(this.bkgImage);else this.webglBackend.setBackgroundColors(this.bkgColor1,this.bkgColor2);return}if(this.bkgImage)this.fillBackgroundWithImage();else this.fillGradientBackground()};JSC3D.Viewer.prototype.fillGradientBackground=function(){var e=this.frameWidth;var t=this.frameHeight;var n=this.bkgColorBuffer;var r=(this.bkgColor1&16711680)>>16;var i=(this.bkgColor1&65280)>>8;var s=this.bkgColor1&255;var o=(this.bkgColor2&16711680)>>16;var u=(this.bkgColor2&65280)>>8;var a=this.bkgColor2&255;var f=this.isBackgroundOn?4278190080:0;var l=0;for(var c=0;c<t;c++){var h=r+c*(o-r)/t&255;var p=i+c*(u-i)/t&255;var d=s+c*(a-s)/t&255;for(var v=0;v<e;v++){n[l++]=f|h<<16|p<<8|d}}};JSC3D.Viewer.prototype.fillBackgroundWithImage=function(){var e=this.frameWidth;var t=this.frameHeight;if(this.bkgImage.width<=0||this.bkgImage.height<=0)return;var n=false;var r=JSC3D.Texture.cv;if(!r){try{r=document.createElement("canvas");JSC3D.Texture.cv=r;n=true}catch(i){return}}if(r.width!=e||r.height!=t){r.width=e;r.height=t;n=true}var s=null;try{var o=r.getContext("2d");if(!n)o.clearRect(0,0,e,t);o.drawImage(this.bkgImage,0,0,e,t);var u=o.getImageData(0,0,e,t);s=u.data}catch(i){return}var a=this.bkgColorBuffer;var f=e*t;var l=this.isBackgroundOn?4278190080:0;for(var c=0,h=0;c<f;c++,h+=4){a[c]=l|s[h]<<16|s[h+1]<<8|s[h+2]}};JSC3D.Viewer.prototype.drawBackground=function(){if(!this.webglBackend&&!this.ctx2d)return;this.beginScene();this.endScene();this.paint()};JSC3D.Viewer.prototype.beginScene=function(){if(this.webglBackend){this.webglBackend.beginFrame(this.definition,this.isBackgroundOn);return}var e=this.colorBuffer;var t=this.zBuffer;var n=this.selectionBuffer;var r=this.bkgColorBuffer;var i=this.frameWidth*this.frameHeight;var s=-Infinity;for(var o=0;o<i;o++){e[o]=r[o];t[o]=s;n[o]=0}};JSC3D.Viewer.prototype.endScene=function(){if(this.webglBackend){this.webglBackend.endFrame();return}var e=this.canvasData.data;var t=this.canvas.width;var n=this.canvas.height;var r=this.colorBuffer;var i=this.frameWidth;var s=this.frameHeight;var o=i*s;switch(this.definition){case"low":var u=t>>1;var a=i-u;var f=0,l=0;for(var c=0;c<n;c++){for(var h=0;h<t;h++){var p=r[f];e[l]=(p&16711680)>>16;e[l+1]=(p&65280)>>8;e[l+2]=p&255;e[l+3]=p>>>24;f+=h&1;l+=4}f+=c&1?a:-u}break;case"high":var f=0,l=0;for(var c=0;c<n;c++){for(var h=0;h<t;h++){var d=r[f];var v=r[f+1];var m=r[f+i];var g=r[f+i+1];e[l]=(d&16711680)+(v&16711680)+(m&16711680)+(g&16711680)>>18;e[l+1]=(d&65280)+(v&65280)+(m&65280)+(g&65280)>>10;e[l+2]=(d&255)+(v&255)+(m&255)+(g&255)>>2;e[l+3]=d>>>24;f+=2;l+=4}f+=i}break;case"standard":default:for(var f=0,l=0;f<o;f++,l+=4){var p=r[f];e[l]=(p&16711680)>>16;e[l+1]=(p&65280)>>8;e[l+2]=p&255;e[l+3]=p>>>24}break}};JSC3D.Viewer.prototype.render=function(){if(this.scene.isEmpty())return;var e=this.scene.aabb;if(this.webglBackend){var t=this.frameWidth;var n=this.frameHeight;var r=e.lengthOfDiagonal();this.transformMatrix.identity();this.transformMatrix.translate(-.5*(e.minX+e.maxX),-.5*(e.minY+e.maxY),-.5*(e.minZ+e.maxZ));this.transformMatrix.multiply(this.rotMatrix);this.transformMatrix.scale(2*this.zoomFactor/t,2*this.zoomFactor/n,-2/r);this.transformMatrix.translate(2*this.panning[0]/t,-2*this.panning[1]/n,0)}else{this.transformMatrix.identity();this.transformMatrix.translate(-.5*(e.minX+e.maxX),-.5*(e.minY+e.maxY),-.5*(e.minZ+e.maxZ));this.transformMatrix.multiply(this.rotMatrix);this.transformMatrix.scale(this.zoomFactor,-this.zoomFactor,this.zoomFactor);this.transformMatrix.translate(.5*this.frameWidth+this.panning[0],.5*this.frameHeight+this.panning[1],0)}var i=this.sortScene(this.transformMatrix);if(this.webglBackend){this.webglBackend.render(this.scene.getChildren(),this.transformMatrix,this.rotMatrix,this.renderMode,this.defaultMaterial,this.sphereMap);return}for(var s=0;s<i.length;s++){var o=i[s];if(!o.isTrivial()){JSC3D.Math3D.transformVectors(this.transformMatrix,o.vertexBuffer,o.transformedVertexBuffer);if(o.visible){switch(o.renderMode||this.renderMode){case"point":this.renderPoint(o);break;case"wireframe":this.renderWireframe(o);break;case"flat":this.renderSolidFlat(o);break;case"smooth":this.renderSolidSmooth(o);break;case"texture":if(o.hasTexture())this.renderSolidTexture(o);else this.renderSolidFlat(o);break;case"textureflat":if(o.hasTexture())this.renderTextureFlat(o);else this.renderSolidFlat(o);break;case"texturesmooth":if(o.isEnvironmentCast&&this.sphereMap!=null&&this.sphereMap.hasData())this.renderSolidSphereMapped(o);else if(o.hasTexture())this.renderTextureSmooth(o);else this.renderSolidSmooth(o);break;default:this.renderSolidFlat(o);break}}}}};JSC3D.Viewer.prototype.sortScene=function(e){var t=[];var n=this.scene.getChildren();for(var r=0;r<n.length;r++){var i=n[r];if(!i.isTrivial()){t.push(i);var s=i.aabb.center();JSC3D.Math3D.transformVectors(e,s,s);var o=i.material?i.material:this.defaultMaterial;i.sortKey={depth:s[2],isTransparnt:o.transparency>0||(i.hasTexture()?i.texture.hasTransparency:false)}}}t.sort(function(e,t){if(!e.sortKey.isTransparnt&&t.sortKey.isTransparnt)return-1;if(e.sortKey.isTransparnt&&!t.sortKey.isTransparnt)return 1;if(e.sortKey.isTransparnt)return e.sortKey.depth-t.sortKey.depth;return t.sortKey.depth-e.sortKey.depth});return t};JSC3D.Viewer.prototype.renderPoint=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=t-1;var i=n-1;var s=e.indexBuffer;var o=e.transformedVertexBuffer;var u=this.colorBuffer;var a=this.zBuffer;var f=this.selectionBuffer;var l=o.length/3;var c=e.internalId;var h=4278190080|(e.material?e.material.diffuseColor:this.defaultMaterial.diffuseColor);for(var p=0,d=0;p<l;p++,d+=3){var v=~~(o[d]+.5);var m=~~(o[d+1]+.5);var g=o[d+2];if(v>=0&&v<r&&m>=0&&m<i){var y=m*t+v;if(g>a[y]){a[y]=g;u[y]=h;f[y]=c}y++;if(g>a[y]){a[y]=g;u[y]=h;f[y]=c}y+=r;if(g>a[y]){a[y]=g;u[y]=h;f[y]=c}y++;if(g>a[y]){a[y]=g;u[y]=h;f[y]=c}}}};JSC3D.Viewer.prototype.renderWireframe=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=t-1;var i=n-1;var s=e.indexBuffer;var o=e.transformedVertexBuffer;var u=e.transformedFaceNormalZBuffer;var a=this.colorBuffer;var f=this.zBuffer;var l=this.selectionBuffer;var c=e.faceCount;var h=e.internalId;var p=4278190080|(e.material?e.material.diffuseColor:this.defaultMaterial.diffuseColor);if(!u||u.length<c){e.transformedFaceNormalZBuffer=new Array(c);u=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,u);var d=0,v=0;while(d<c){var m=u[d++];if(e.isDoubleSided)m=m>0?m:-m;if(m<0){do{}while(s[v++]!=-1)}else{var g,y,b;y=s[v++]*3;b=s[v++]*3;g=y;var w=false;while(!w){var E=~~(o[y]+.5);var S=~~(o[y+1]+.5);var x=o[y+2];var T=~~(o[b]+.5);var N=~~(o[b+1]+.5);var C=o[b+2];var k=T-E;var L=N-S;var A=C-x;var O;var M,_,D;if(Math.abs(k)>Math.abs(L)){O=k;M=k>0?1:-1;_=k!=0?M*L/k:0;D=k!=0?M*A/k:0}else{O=L;_=L>0?1:-1;M=L!=0?_*k/L:0;D=L!=0?_*A/L:0}var P=E;var H=S;var B=x;if(O<0){P=T;H=N;B=C;O=-O;M=-M;_=-_;D=-D}for(var j=0;j<O;j++){if(P>=0&&P<r&&H>=0&&H<i){var F=~~H*t+~~P;if(B>f[F]){f[F]=B;a[F]=p;l[F]=h}}P+=M;H+=_;B+=D}if(b==g){w=true}else{y=b;if(s[v]!=-1){b=s[v++]*3}else{b=g}}}v++}}};JSC3D.Viewer.prototype.renderSolidFlat=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedFaceNormalZBuffer;var o=this.colorBuffer;var u=this.zBuffer;var a=this.selectionBuffer;var f=e.faceCount;var l=e.internalId;var c=e.material?e.material:this.defaultMaterial;var h=c.getPalette();var p=c.transparency==0;var d=c.transparency*255;var v=255-d;var m=1*null;if(c.transparency==1)return;if(!s||s.length<f){e.transformedFaceNormalZBuffer=new Array(f);s=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,s);var g=new Array(3);var y=new Array(3);var b=new Array(3);var w=0,E=0;while(w<f){var S=s[w++];if(e.isDoubleSided)S=S>0?S:-S;if(S<0){do{}while(r[E++]!=-1)}else{var x=4278190080|h[~~(S*255)];var T,N,C;T=r[E++]*3;N=r[E++]*3;do{C=r[E++]*3;g[0]=~~(i[T]+.5);y[0]=~~(i[T+1]+.5);b[0]=i[T+2];g[1]=~~(i[N]+.5);y[1]=~~(i[N+1]+.5);b[1]=i[N+2];g[2]=~~(i[C]+.5);y[2]=~~(i[C+1]+.5);b[2]=i[C+2];var k=y[0]<y[1]?0:1;k=y[k]<y[2]?k:2;var L=y[0]>y[1]?0:1;L=y[L]>y[2]?L:2;var A=3-L-k;if(k!=L){var O=g[L];var M=b[L];var _=y[L]-y[k];_=_!=0?_:1;var D=(g[L]-g[k])/_;var P=(b[L]-b[k])/_;var H=g[L];var B=b[L];var j=y[L]-y[A];j=j!=0?j:1;var F=(g[L]-g[A])/j;var I=(b[L]-b[A])/j;var q=g[A];var R=b[A];var U=y[A]-y[k];U=U!=0?U:1;var z=(g[A]-g[k])/U;var W=(b[A]-b[k])/U;var X=y[L]*t;for(var V=y[L];V>y[k];V--){if(V>=0&&V<n){var $=~~O;var J=M;var K,Q;if(V>y[A]){K=~~H;Q=B}else{K=~~q;Q=R}if($>K){var G;G=$;$=K;K=G;G=J;J=Q;Q=G}if($<0)$=0;if(K>=t)K=t-1;var Y=$!=K?(Q-J)/(K-$):1;var Z=X+$;if(p){for(var et=$,tt=J;et<=K;et++,tt+=Y){if(tt>u[Z]){u[Z]=tt;o[Z]=x;a[Z]=l}Z++}}else{for(var et=$,tt=J;et<K;et++,tt+=Y){if(tt>u[Z]){var nt=x;var rt=o[Z];var it=(rt&16711680)*d+(nt&16711680)*v>>8;var st=(rt&65280)*d+(nt&65280)*v>>8;var ot=(rt&255)*d+(nt&255)*v>>8;var ut=rt&4278190080|v<<24;o[Z]=ut|it&16711680|st&65280|ot&255;a[Z]=l}Z++}}}O-=D;M-=P;if(V>y[A]){H-=F;B-=I}else{q-=z;R-=W}X-=t}}N=C}while(r[E]!=-1);E++}}};JSC3D.Viewer.prototype.renderSolidSmooth=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedVertexNormalZBuffer;var o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer;var u=e.transformedFaceNormalZBuffer;var a=this.colorBuffer;var f=this.zBuffer;var l=this.selectionBuffer;var c=e.faceCount;var h=i.length/3;var p=e.internalId;var d=e.material?e.material:this.defaultMaterial;var v=d.getPalette();var m=d.transparency==0;var g=d.transparency*255;var y=255-g;var b=1*null;if(d.transparency==1)return;if(!s||s.length<e.vertexNormalBuffer.length/3){e.transformedVertexNormalZBuffer=new Array(e.vertexNormalBuffer.length/3);s=e.transformedVertexNormalZBuffer}if(!u||u.length<c){e.transformedFaceNormalZBuffer=new Array(c);u=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.vertexNormalBuffer,s);JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,u);var w=e.isDoubleSided;var E=new Array(3);var S=new Array(3);var x=new Array(3);var T=new Array(3);var N=0,C=0;while(N<c){var k=u[N++];if(w)k=k>0?k:-k;if(k<0){do{}while(r[C++]!=-1)}else{var L,A,O;var M,_,D;var P,H,B;L=r[C];M=L*3;P=o[C];C++;A=r[C];_=A*3;H=o[C];C++;do{O=r[C];D=O*3;B=o[C];C++;E[0]=~~(i[M]+.5);S[0]=~~(i[M+1]+.5);x[0]=i[M+2];E[1]=~~(i[_]+.5);S[1]=~~(i[_+1]+.5);x[1]=i[_+2];E[2]=~~(i[D]+.5);S[2]=~~(i[D+1]+.5);x[2]=i[D+2];T[0]=s[P];T[1]=s[H];T[2]=s[B];if(w){if(T[0]<0)T[0]=-T[0];if(T[1]<0)T[1]=-T[1];if(T[2]<0)T[2]=-T[2]}var j=S[0]<S[1]?0:1;j=S[j]<S[2]?j:2;var F=S[0]>S[1]?0:1;F=S[F]>S[2]?F:2;var I=3-F-j;if(j!=F){var q=E[F];var R=x[F];var U=T[F]*255;var z=S[F]-S[j];z=z!=0?z:1;var W=(E[F]-E[j])/z;var X=(x[F]-x[j])/z;var V=(T[F]-T[j])*255/z;var $=E[F];var J=x[F];var K=T[F]*255;var Q=S[F]-S[I];Q=Q!=0?Q:1;var G=(E[F]-E[I])/Q;var Y=(x[F]-x[I])/Q;var Z=(T[F]-T[I])*255/Q;var et=E[I];var tt=x[I];var nt=T[I]*255;var rt=S[I]-S[j];rt=rt!=0?rt:1;var it=(E[I]-E[j])/rt;var st=(x[I]-x[j])/rt;var ot=(T[I]-T[j])*255/rt;var ut=S[F]*t;for(var at=S[F];at>S[j];at--){if(at>=0&&at<n){var ft=~~q;var lt=R;var ct=U;var ht,pt,dt;if(at>S[I]){ht=~~$;pt=J;dt=K}else{ht=~~et;pt=tt;dt=nt}if(ft>ht){var vt;vt=ft;ft=ht;ht=vt;vt=lt;lt=pt;pt=vt;vt=ct;ct=dt;dt=vt}var mt=ft!=ht?(pt-lt)/(ht-ft):1;var gt=ft!=ht?(dt-ct)/(ht-ft):1;if(ft<0){lt-=ft*mt;ct-=ft*gt;ft=0}if(ht>=t){ht=t-1}var yt=ut+ft;if(m){for(var bt=ft,wt=lt,Et=ct;bt<=ht;bt++,wt+=mt,Et+=gt){if(wt>f[yt]){f[yt]=wt;a[yt]=4278190080|v[Et>0?~~Et:0];l[yt]=p}yt++}}else{for(var bt=ft,wt=lt,Et=ct;bt<ht;bt++,wt+=mt,Et+=gt){if(wt>f[yt]){var St=v[Et>0?~~Et:0];var xt=a[yt];var Tt=(xt&16711680)*g+(St&16711680)*y>>8;var Nt=(xt&65280)*g+(St&65280)*y>>8;var Ct=(xt&255)*g+(St&255)*y>>8;var kt=xt&4278190080|y<<24;a[yt]=kt|Tt&16711680|Nt&65280|Ct&255;l[yt]=p}yt++}}}q-=W;R-=X;U-=V;if(at>S[I]){$-=G;J-=Y;K-=Z}else{et-=it;tt-=st;nt-=ot}ut-=t}}_=D;A=O;H=B}while(r[C]!=-1);C++}}};JSC3D.Viewer.prototype.renderSolidTexture=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedFaceNormalZBuffer;var o=this.colorBuffer;var u=this.zBuffer;var a=this.selectionBuffer;var f=e.faceCount;var l=e.internalId;var c=e.texture;var h=!c.hasTransparency;var p=e.texCoordBuffer;var d=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer;var v=c.data;var m=c.width;var g=m-1;var y=c.hasMipmap()?c.mipmaps:null;var b=y?c.mipentries:null;var w=1*null;if(!s||s.length<f){e.transformedFaceNormalZBuffer=new Array(f);s=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,s);var E=new Array(3);var S=new Array(3);var x=new Array(3);var T=new Array(3);var N=new Array(3);var C=0,k=0;while(C<f){var L=s[C++];if(e.isDoubleSided)L=L>0?L:-L;if(L<0){do{}while(r[k++]!=-1)}else{var A,O,M;var _,D,P;A=r[k]*3;_=d[k]*2;k++;O=r[k]*3;D=d[k]*2;k++;if(y){M=r[k]*3;P=d[k]*2;m=c.width;E[0]=i[A];S[0]=i[A+1];E[1]=i[O];S[1]=i[O+1];E[2]=i[M];S[2]=i[M+1];T[0]=p[_]*m;N[0]=p[_+1]*m;T[1]=p[D]*m;N[1]=p[D+1]*m;T[2]=p[P]*m;N[2]=p[P+1]*m;var H=(E[1]-E[0])*(S[2]-S[0])-(S[1]-S[0])*(E[2]-E[0]);if(H<0)H=-H;H+=1;var B=(T[1]-T[0])*(N[2]-N[0])-(N[1]-N[0])*(T[2]-T[0]);if(B<0)B=-B;var j=B/H;var F=0;if(j<b[1])F=0;else if(j>=b[b.length-1]){F=b.length-1;m=1}else{while(j>=b[F+1]){F++;m/=2}}v=y[F];g=m-1}do{M=r[k]*3;P=d[k]*2;k++;E[0]=~~(i[A]+.5);S[0]=~~(i[A+1]+.5);x[0]=i[A+2];E[1]=~~(i[O]+.5);S[1]=~~(i[O+1]+.5);x[1]=i[O+2];E[2]=~~(i[M]+.5);S[2]=~~(i[M+1]+.5);x[2]=i[M+2];T[0]=p[_]*m;N[0]=p[_+1]*m;T[1]=p[D]*m;N[1]=p[D+1]*m;T[2]=p[P]*m;N[2]=p[P+1]*m;var I=S[0]<S[1]?0:1;I=S[I]<S[2]?I:2;var q=S[0]>S[1]?0:1;q=S[q]>S[2]?q:2;var R=3-q-I;if(I!=q){var U=E[q];var z=x[q];var W=T[q];var X=N[q];var V=S[q]-S[I];V=V!=0?V:1;var $=(E[q]-E[I])/V;var J=(x[q]-x[I])/V;var K=(T[q]-T[I])/V;var Q=(N[q]-N[I])/V;var G=E[q];var Y=x[q];var Z=T[q];var et=N[q];var tt=S[q]-S[R];tt=tt!=0?tt:1;var nt=(E[q]-E[R])/tt;var rt=(x[q]-x[R])/tt;var it=(T[q]-T[R])/tt;var st=(N[q]-N[R])/tt;var ot=E[R];var ut=x[R];var at=T[R];var ft=N[R];var lt=S[R]-S[I];lt=lt!=0?lt:1;var ct=(E[R]-E[I])/lt;var ht=(x[R]-x[I])/lt;var pt=(T[R]-T[I])/lt;var dt=(N[R]-N[I])/lt;var vt=S[q]*t;for(var mt=S[q];mt>S[I];mt--){if(mt>=0&&mt<n){var gt=~~U;var yt=z;var bt=W;var wt=X;var Et,St,xt,Tt;if(mt>S[R]){Et=~~G;St=Y;xt=Z;Tt=et}else{Et=~~ot;St=ut;xt=at;Tt=ft}if(gt>Et){var Nt;Nt=gt;gt=Et;Et=Nt;Nt=yt;yt=St;St=Nt;Nt=bt;bt=xt;xt=Nt;Nt=wt;wt=Tt;Tt=Nt}var Ct=gt!=Et?(St-yt)/(Et-gt):1;var kt=gt!=Et?(xt-bt)/(Et-gt):1;var Lt=gt!=Et?(Tt-wt)/(Et-gt):1;if(gt<0){yt-=gt*Ct;bt-=gt*kt;wt-=gt*Lt;gt=0}if(Et>=t)Et=t-1;var At=vt+gt;if(h){for(var Ot=gt,Mt=yt,_t=bt,Dt=wt;Ot<=Et;Ot++,Mt+=Ct,_t+=kt,Dt+=Lt){if(Mt>u[At]){u[At]=Mt;o[At]=v[(Dt&g)*m+(_t&g)];a[At]=l}At++}}else{for(var Ot=gt,Mt=yt,_t=bt,Dt=wt;Ot<Et;Ot++,Mt+=Ct,_t+=kt,Dt+=Lt){if(Mt>u[At]){var Pt=v[(Dt&g)*m+(_t&g)];var Ht=o[At];var Bt=Pt>>24&255;var jt=255-Bt;var Ft=(Ht&16711680)*jt+(Pt&16711680)*Bt>>8;var It=(Ht&65280)*jt+(Pt&65280)*Bt>>8;var qt=(Ht&255)*jt+(Pt&255)*Bt>>8;var Rt=Ht&4278190080|Bt<<24;o[At]=Rt|Ft&16711680|It&65280|qt&255;a[At]=l}At++}}}U-=$;z-=J;W-=K;X-=Q;if(mt>S[R]){G-=nt;Y-=rt;Z-=it;et-=st}else{ot-=ct;ut-=ht;at-=pt;ft-=dt}vt-=t}}O=M;D=P}while(r[k]!=-1);k++}}};JSC3D.Viewer.prototype.renderTextureFlat=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedFaceNormalZBuffer;var o=this.colorBuffer;var u=this.zBuffer;var a=this.selectionBuffer;var f=e.faceCount;var l=e.internalId;var c=e.material?e.material:this.defaultMaterial;var h=c.getPalette();var p=e.texture;var d=c.transparency==0&&!p.hasTransparency;var v=~~((1-c.transparency)*255);var m=e.texCoordBuffer;var g=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer;var y=p.data;var b=p.width;var w=b-1;var E=p.hasMipmap()?p.mipmaps:null;var S=E?p.mipentries:null;var x=1*null;if(c.transparency==1)return;if(!s||s.length<f){e.transformedFaceNormalZBuffer=new Array(f);s=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,s);var T=new Array(3);var N=new Array(3);var C=new Array(3);var k=new Array(3);var L=new Array(3);var A=0,O=0;while(A<f){var M=s[A++];if(e.isDoubleSided)M=M>0?M:-M;if(M<0){do{}while(r[O++]!=-1)}else{var _=4278190080|h[~~(M*255)];var D,P,H;var B,j,F;D=r[O]*3;B=g[O]*2;O++;P=r[O]*3;j=g[O]*2;O++;if(E){H=r[O]*3;F=g[O]*2;b=p.width;T[0]=i[D];N[0]=i[D+1];T[1]=i[P];N[1]=i[P+1];T[2]=i[H];N[2]=i[H+1];k[0]=m[B]*b;L[0]=m[B+1]*b;k[1]=m[j]*b;L[1]=m[j+1]*b;k[2]=m[F]*b;L[2]=m[F+1]*b;var I=(T[1]-T[0])*(N[2]-N[0])-(N[1]-N[0])*(T[2]-T[0]);if(I<0)I=-I;I+=1;var q=(k[1]-k[0])*(L[2]-L[0])-(L[1]-L[0])*(k[2]-k[0]);if(q<0)q=-q;var R=q/I;var U=0;if(R<S[1])U=0;else if(R>=S[S.length-1]){U=S.length-1;b=1}else{while(R>=S[U+1]){U++;b/=2}}y=E[U];w=b-1}do{H=r[O]*3;F=g[O]*2;O++;T[0]=~~(i[D]+.5);N[0]=~~(i[D+1]+.5);C[0]=i[D+2];T[1]=~~(i[P]+.5);N[1]=~~(i[P+1]+.5);C[1]=i[P+2];T[2]=~~(i[H]+.5);N[2]=~~(i[H+1]+.5);C[2]=i[H+2];k[0]=m[B]*b;L[0]=m[B+1]*b;k[1]=m[j]*b;L[1]=m[j+1]*b;k[2]=m[F]*b;L[2]=m[F+1]*b;var z=N[0]<N[1]?0:1;z=N[z]<N[2]?z:2;var W=N[0]>N[1]?0:1;W=N[W]>N[2]?W:2;var X=3-W-z;if(z!=W){var V=T[W];var $=C[W];var J=k[W];var K=L[W];var Q=N[W]-N[z];Q=Q!=0?Q:1;var G=(T[W]-T[z])/Q;var Y=(C[W]-C[z])/Q;var Z=(k[W]-k[z])/Q;var et=(L[W]-L[z])/Q;var tt=T[W];var nt=C[W];var rt=k[W];var it=L[W];var st=N[W]-N[X];st=st!=0?st:1;var ot=(T[W]-T[X])/st;var ut=(C[W]-C[X])/st;var at=(k[W]-k[X])/st;var ft=(L[W]-L[X])/st;var lt=T[X];var ct=C[X];var ht=k[X];var pt=L[X];var dt=N[X]-N[z];dt=dt!=0?dt:1;var vt=(T[X]-T[z])/dt;var mt=(C[X]-C[z])/dt;var gt=(k[X]-k[z])/dt;var yt=(L[X]-L[z])/dt;var bt=N[W]*t;for(var wt=N[W];wt>N[z];wt--){if(wt>=0&&wt<n){var Et=~~V;var St=$;var xt=J;var Tt=K;var Nt,Ct,kt,Lt;if(wt>N[X]){Nt=~~tt;Ct=nt;kt=rt;Lt=it}else{Nt=~~lt;Ct=ct;kt=ht;Lt=pt}if(Et>Nt){var At;At=Et;Et=Nt;Nt=At;At=St;St=Ct;Ct=At;At=xt;xt=kt;kt=At;At=Tt;Tt=Lt;Lt=At}var Ot=Et!=Nt?(Ct-St)/(Nt-Et):1;var Mt=Et!=Nt?(kt-xt)/(Nt-Et):1;var _t=Et!=Nt?(Lt-Tt)/(Nt-Et):1;if(Et<0){St-=Et*Ot;xt-=Et*Mt;Tt-=Et*_t;Et=0}if(Nt>=t)Nt=t-1;var Dt=bt+Et;if(d){for(var Pt=Et,Ht=St,Bt=xt,jt=Tt;Pt<=Nt;Pt++,Ht+=Ot,Bt+=Mt,jt+=_t){if(Ht>u[Dt]){u[Dt]=Ht;var Ft=y[(jt&w)*b+(Bt&w)];var It=((_&16711680)>>16)*((Ft&16711680)>>8);var qt=((_&65280)>>8)*((Ft&65280)>>8);var Rt=(_&255)*(Ft&255)>>8;o[Dt]=4278190080|It&16711680|qt&65280|Rt&255;a[Dt]=l}Dt++}}else{for(var Pt=Et,Ht=St,Bt=xt,jt=Tt;Pt<Nt;Pt++,Ht+=Ot,Bt+=Mt,jt+=_t){if(Ht>u[Dt]){var Ut=y[(jt&w)*b+(Bt&w)];var zt=o[Dt];var Wt=(Ut>>24&255)*(v&255)>>8;var It=((_&16711680)>>16)*((Ut&16711680)>>8);var qt=((_&65280)>>8)*((Ut&65280)>>8);var Rt=(_&255)*(Ut&255)>>8;var Xt=zt&4278190080|Wt<<24;if(Wt>250){u[Dt]=Ht}else{var Vt=255-Wt;It=It*Wt+(zt&16711680)*Vt>>8;qt=qt*Wt+(zt&65280)*Vt>>8;Rt=Rt*Wt+(zt&255)*Vt>>8}o[Dt]=Xt|It&16711680|qt&65280|Rt&255;a[Dt]=l}Dt++}}}V-=G;$-=Y;J-=Z;K-=et;if(wt>N[X]){tt-=ot;nt-=ut;rt-=at;it-=ft}else{lt-=vt;ct-=mt;ht-=gt;pt-=yt}bt-=t}}P=H;j=F}while(r[O]!=-1);O++}}};JSC3D.Viewer.prototype.renderTextureSmooth=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedVertexNormalZBuffer;var o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer;var u=e.transformedFaceNormalZBuffer;var a=this.colorBuffer;var f=this.zBuffer;var l=this.selectionBuffer;var c=e.faceCount;var h=e.internalId;var p=i.length/3;var d=e.material?e.material:this.defaultMaterial;var v=d.getPalette();var m=e.texture;var g=d.transparency==0&&!m.hasTransparency;var y=~~((1-d.transparency)*255);var b=e.texCoordBuffer;var w=e.texCoordIndexBuffer?e.texCoordIndexBuffer:e.indexBuffer;var E=m.data;var S=m.width;var x=S-1;var T=m.hasMipmap()?m.mipmaps:null;var N=T?m.mipentries:null;var C=1*null;if(d.transparency==1)return;if(!s||s.length<e.vertexNormalBuffer.length/3){e.transformedVertexNormalZBuffer=new Array(e.vertexNormalBuffer.length/3);s=e.transformedVertexNormalZBuffer}if(!u||u.length<c){e.transformedFaceNormalZBuffer=new Array(c);u=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.vertexNormalBuffer,s);JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,u);var k=e.isDoubleSided;var L=new Array(3);var A=new Array(3);var O=new Array(3);var M=new Array(3);var _=new Array(3);var D=new Array(3);var P=0,H=0;while(P<c){var B=u[P++];if(k)B=B>0?B:-B;if(B<0){do{}while(r[H++]!=-1)}else{var j,F,I;var q,R,U;var z,W,X;var V,$,J;j=r[H];q=j*3;z=w[H]*2;V=o[H];H++;F=r[H];R=F*3;W=w[H]*2;$=o[H];H++;if(T){U=r[H]*3;X=w[H]*2;S=m.width;L[0]=i[q];A[0]=i[q+1];L[1]=i[R];A[1]=i[R+1];L[2]=i[U];A[2]=i[U+1];_[0]=b[z]*S;D[0]=b[z+1]*S;_[1]=b[W]*S;D[1]=b[W+1]*S;_[2]=b[X]*S;D[2]=b[X+1]*S;var K=(L[1]-L[0])*(A[2]-A[0])-(A[1]-A[0])*(L[2]-L[0]);if(K<0)K=-K;K+=1;var Q=(_[1]-_[0])*(D[2]-D[0])-(D[1]-D[0])*(_[2]-_[0]);if(Q<0)Q=-Q;var G=Q/K;var Y=0;if(G<N[1])Y=0;else if(G>=N[N.length-1]){Y=N.length-1;S=1}else{while(G>=N[Y+1]){Y++;S/=2}}E=T[Y];x=S-1}do{I=r[H];U=I*3;X=w[H]*2;J=o[H];H++;L[0]=~~(i[q]+.5);A[0]=~~(i[q+1]+.5);O[0]=i[q+2];L[1]=~~(i[R]+.5);A[1]=~~(i[R+1]+.5);O[1]=i[R+2];L[2]=~~(i[U]+.5);A[2]=~~(i[U+1]+.5);O[2]=i[U+2];_[0]=b[z]*S;D[0]=b[z+1]*S;_[1]=b[W]*S;D[1]=b[W+1]*S;_[2]=b[X]*S;D[2]=b[X+1]*S;M[0]=s[V];M[1]=s[$];M[2]=s[J];if(k){if(M[0]<0)M[0]=-M[0];if(M[1]<0)M[1]=-M[1];if(M[2]<0)M[2]=-M[2]}var Z=A[0]<A[1]?0:1;Z=A[Z]<A[2]?Z:2;var et=A[0]>A[1]?0:1;et=A[et]>A[2]?et:2;var tt=3-et-Z;if(Z!=et){var nt=L[et];var rt=O[et];var it=_[et];var st=D[et];var ot=M[et]*255;var ut=A[et]-A[Z];ut=ut!=0?ut:1;var at=(L[et]-L[Z])/ut;var ft=(O[et]-O[Z])/ut;var lt=(_[et]-_[Z])/ut;var ct=(D[et]-D[Z])/ut;var ht=(M[et]-M[Z])*255/ut;var pt=L[et];var dt=O[et];var vt=_[et];var mt=D[et];var gt=M[et]*255;var yt=A[et]-A[tt];yt=yt!=0?yt:1;var bt=(L[et]-L[tt])/yt;var wt=(O[et]-O[tt])/yt;var Et=(_[et]-_[tt])/yt;var St=(D[et]-D[tt])/yt;var xt=(M[et]-M[tt])*255/yt;var Tt=L[tt];var Nt=O[tt];var Ct=_[tt];var kt=D[tt];var Lt=M[tt]*255;var At=A[tt]-A[Z];At=At!=0?At:1;var Ot=(L[tt]-L[Z])/At;var Mt=(O[tt]-O[Z])/At;var _t=(_[tt]-_[Z])/At;var Dt=(D[tt]-D[Z])/At;var Pt=(M[tt]-M[Z])*255/At;var Ht=A[et]*t;for(var Bt=A[et];Bt>A[Z];Bt--){if(Bt>=0&&Bt<n){var jt=~~nt;var Ft=rt;var It=it;var qt=st;var Rt=ot;var Ut,zt,Wt,Xt,Vt;if(Bt>A[tt]){Ut=~~pt;zt=dt;Wt=vt;Xt=mt;Vt=gt}else{Ut=~~Tt;zt=Nt;Wt=Ct;Xt=kt;Vt=Lt}if(jt>Ut){var $t;$t=jt;jt=Ut;Ut=$t;$t=Ft;Ft=zt;zt=$t;$t=It;It=Wt;Wt=$t;$t=qt;qt=Xt;Xt=$t;$t=Rt;Rt=Vt;Vt=$t}var Jt=jt!=Ut?(zt-Ft)/(Ut-jt):1;var Kt=jt!=Ut?(Wt-It)/(Ut-jt):1;var Qt=jt!=Ut?(Xt-qt)/(Ut-jt):1;var Gt=jt!=Ut?(Vt-Rt)/(Ut-jt):0;if(jt<0){Ft-=jt*Jt;It-=jt*Kt;qt-=jt*Qt;Rt-=jt*Gt;jt=0}if(Ut>=t)Ut=t-1;var Yt=Ht+jt;if(g){for(var Zt=jt,en=Ft,tn=Rt,nn=It,rn=qt;Zt<=Ut;Zt++,en+=Jt,tn+=Gt,nn+=Kt,rn+=Qt){if(en>f[Yt]){f[Yt]=en;var sn=v[tn>0?~~tn:0];var on=E[(rn&x)*S+(nn&x)];var un=((sn&16711680)>>16)*((on&16711680)>>8);var an=((sn&65280)>>8)*((on&65280)>>8);var fn=(sn&255)*(on&255)>>8;a[Yt]=4278190080|un&16711680|an&65280|fn&255;l[Yt]=h}Yt++}}else{for(var Zt=jt,en=Ft,tn=Rt,nn=It,rn=qt;Zt<Ut;Zt++,en+=Jt,tn+=Gt,nn+=Kt,rn+=Qt){if(en>f[Yt]){var sn=v[tn>0?~~tn:0];var ln=E[(rn&x)*S+(nn&x)];var cn=a[Yt];var hn=(ln>>24&255)*(y&255)>>8;var un=((sn&16711680)>>16)*((ln&16711680)>>8);var an=((sn&65280)>>8)*((ln&65280)>>8);var fn=(sn&255)*(ln&255)>>8;var pn=cn&4278190080|hn<<24;if(hn>250){f[Yt]=en}else{var dn=255-hn;un=un*hn+(cn&16711680)*dn>>8;an=an*hn+(cn&65280)*dn>>8;fn=fn*hn+(cn&255)*dn>>8}a[Yt]=pn|un&16711680|an&65280|fn&255;l[Yt]=h}Yt++}}}nt-=at;rt-=ft;it-=lt;st-=ct;ot-=ht;if(Bt>A[tt]){pt-=bt;dt-=wt;vt-=Et;mt-=St;gt-=xt}else{Tt-=Ot;Nt-=Mt;Ct-=_t;kt-=Dt;Lt-=Pt}Ht-=t}}F=I;R=U;W=X;$=J}while(r[H]!=-1);H++}}};JSC3D.Viewer.prototype.renderSolidSphereMapped=function(e){var t=this.frameWidth;var n=this.frameHeight;var r=e.indexBuffer;var i=e.transformedVertexBuffer;var s=e.transformedVertexNormalBuffer;var o=e.vertexNormalIndexBuffer?e.vertexNormalIndexBuffer:e.indexBuffer;var u=e.transformedFaceNormalZBuffer;var a=this.colorBuffer;var f=this.zBuffer;var l=this.selectionBuffer;var c=e.faceCount;var h=i.length/3;var p=e.internalId;var d=e.material?e.material:this.defaultMaterial;var v=d.getPalette();var m=this.sphereMap;var g=m.data;var y=m.width;var b=y-1;var w=d.transparency==0;var E=d.transparency*255;var S=255-E;var x=1*null;if(d.transparency==1)return;if(!s||s.length<e.vertexNormalBuffer.length){e.transformedVertexNormalBuffer=new Array(e.vertexNormalBuffer.length);s=e.transformedVertexNormalBuffer}if(!u||u.length<c){e.transformedFaceNormalZBuffer=new Array(c);u=e.transformedFaceNormalZBuffer}JSC3D.Math3D.transformVectors(this.rotMatrix,e.vertexNormalBuffer,s);JSC3D.Math3D.transformVectorZs(this.rotMatrix,e.faceNormalBuffer,u);var T=e.isDoubleSided;var N=new Array(3);var C=new Array(3);var k=new Array(3);var L=new Array(3);var A=new Array(3);var O=new Array(3);var M=0,_=0;while(M<c){var D=u[M++];if(T)D=D>0?D:-D;if(D<0){do{}while(r[_++]!=-1)}else{var P,H,B;var j,F,I;P=r[_]*3;j=o[_]*3;_++;H=r[_]*3;F=o[_]*3;_++;do{B=r[_]*3;I=o[_]*3;_++;N[0]=~~(i[P]+.5);C[0]=~~(i[P+1]+.5);k[0]=i[P+2];N[1]=~~(i[H]+.5);C[1]=~~(i[H+1]+.5);k[1]=i[H+2];N[2]=~~(i[B]+.5);C[2]=~~(i[B+1]+.5);k[2]=i[B+2];L[0]=s[j];A[0]=s[j+1];O[0]=s[j+2];L[1]=s[F];A[1]=s[F+1];O[1]=s[F+2];L[2]=s[I];A[2]=s[I+1];O[2]=s[I+2];if(T){if(O[0]<0)O[0]=-O[0];if(O[1]<0)O[1]=-O[1];if(O[2]<0)O[2]=-O[2]}var q=C[0]<C[1]?0:1;q=C[q]<C[2]?q:2;var R=C[0]>C[1]?0:1;R=C[R]>C[2]?R:2;var U=3-R-q;if(q!=R){var z=N[R];var W=k[R];var X=O[R]*255;var V=(L[R]/2+.5)*y&b;var $=(.5-A[R]/2)*y&b;var J=C[R]-C[q];J=J!=0?J:1;var K=(N[R]-N[q])/J;var Q=(k[R]-k[q])/J;var G=(O[R]-O[q])*255/J;var Y=(L[R]-L[q])/2*y/J;var Z=(A[q]-A[R])/2*y/J;var et=N[R];var tt=k[R];var nt=O[R]*255;var rt=(L[R]/2+.5)*y&b;var it=(.5-A[R]/2)*y&b;var st=C[R]-C[U];st=st!=0?st:1;var ot=(N[R]-N[U])/st;var ut=(k[R]-k[U])/st;var at=(O[R]-O[U])*255/st;var ft=(L[R]-L[U])/2*y/st;var lt=(A[U]-A[R])/2*y/st;var ct=N[U];var ht=k[U];var pt=O[U]*255;var dt=(L[U]/2+.5)*y&b;var vt=(.5-A[U]/2)*y&b;var mt=C[U]-C[q];mt=mt!=0?mt:1;var gt=(N[U]-N[q])/mt;var yt=(k[U]-k[q])/mt;var bt=(O[U]-O[q])*255/mt;var wt=(L[U]-L[q])/2*y/mt;var Et=(A[q]-A[U])/2*y/mt;var St=C[R]*t;for(var xt=C[R];xt>C[q];xt--){if(xt>=0&&xt<n){var Tt=~~z;var Nt=W;var Ct=X;var kt=V;var Lt=$;var At,Ot,Mt,_t,Dt;if(xt>C[U]){At=~~et;Ot=tt;Mt=nt;_t=rt;Dt=it}else{At=~~ct;Ot=ht;Mt=pt;_t=dt;Dt=vt}if(Tt>At){var Pt;Pt=Tt;Tt=At;At=Pt;Pt=Nt;Nt=Ot;Ot=Pt;Pt=Ct;Ct=Mt;Mt=Pt;Pt=kt;kt=_t;_t=Pt;Pt=Lt;Lt=Dt;Dt=Pt}var Ht=Tt!=At?(Ot-Nt)/(At-Tt):1;var Bt=Tt!=At?(Mt-Ct)/(At-Tt):1;var jt=Tt!=At?(_t-kt)/(At-Tt):1;var Ft=Tt!=At?(Dt-Lt)/(At-Tt):1;if(Tt<0){Nt-=Tt*Ht;Ct-=Tt*Bt;kt-=kt*jt;Lt-=Lt*Ft;Tt=0}if(At>=t){At=t-1}var It=St+Tt;if(w){for(var qt=Tt,Rt=Nt,Ut=Ct,zt=kt,Wt=Lt;qt<=At;qt++,Rt+=Ht,Ut+=Bt,zt+=jt,Wt+=Ft){if(Rt>f[It]){f[It]=Rt;var Xt=v[Ut>0?~~Ut:0];var Vt=g[(Wt&b)*y+(zt&b)];var $t=((Xt&16711680)>>16)*((Vt&16711680)>>8);var Jt=((Xt&65280)>>8)*((Vt&65280)>>8);var Kt=(Xt&255)*(Vt&255)>>8;a[It]=4278190080|$t&16711680|Jt&65280|Kt&255;l[It]=p}It++}}else{for(var qt=Tt,Rt=Nt,Ut=Ct,zt=kt,Wt=Lt;qt<At;qt++,Rt+=Ht,Ut+=Bt,zt+=jt,Wt+=Ft){if(Rt>f[It]){var Xt=v[Ut>0?~~Ut:0];var Qt=g[(Wt&b)*y+(zt&b)];var Gt=a[It];var $t=((Xt&16711680)>>16)*((Qt&16711680)>>8);var Jt=((Xt&65280)>>8)*((Qt&65280)>>8);var Kt=(Xt&255)*(Qt&255)>>8;var Yt=(Gt|Xt)&4278190080;$t=$t*S+(Gt&16711680)*E>>8;Jt=Jt*S+(Gt&65280)*E>>8;Kt=Kt*S+(Gt&255)*E>>8;a[It]=Yt|$t&16711680|Jt&65280|Kt&255;l[It]=p}It++}}}z-=K;W-=Q;X-=G;V-=Y;$-=Z;if(xt>C[U]){et-=ot;tt-=ut;nt-=at;rt-=ft;it-=lt}else{ct-=gt;ht-=yt;pt-=bt;dt-=wt;vt-=Et}St-=t}}H=B;F=I}while(r[_]!=-1);_++}}};JSC3D.Viewer.prototype.params=null;JSC3D.Viewer.prototype.canvas=null;JSC3D.Viewer.prototype.ctx2d=null;JSC3D.Viewer.prototype.canvasData=null;JSC3D.Viewer.prototype.bkgColorBuffer=null;JSC3D.Viewer.prototype.colorBuffer=null;JSC3D.Viewer.prototype.zBuffer=null;JSC3D.Viewer.prototype.selectionBuffer=null;JSC3D.Viewer.prototype.frameWidth=0;JSC3D.Viewer.prototype.frameHeight=0;JSC3D.Viewer.prototype.scene=null;JSC3D.Viewer.prototype.defaultMaterial=null;JSC3D.Viewer.prototype.sphereMap=null;JSC3D.Viewer.prototype.isLoaded=false;JSC3D.Viewer.prototype.isFailed=false;JSC3D.Viewer.prototype.needUpdate=false;JSC3D.Viewer.prototype.needRepaint=false;JSC3D.Viewer.prototype.initRotX=0;JSC3D.Viewer.prototype.initRotY=0;JSC3D.Viewer.prototype.initRotZ=0;JSC3D.Viewer.prototype.zoomFactor=1;JSC3D.Viewer.prototype.panning=[0,0];JSC3D.Viewer.prototype.rotMatrix=null;JSC3D.Viewer.prototype.transformMatrix=null;JSC3D.Viewer.prototype.sceneUrl="";JSC3D.Viewer.prototype.modelColor=13280792;JSC3D.Viewer.prototype.bkgColor1=16777215;JSC3D.Viewer.prototype.bkgColor2=16777088;JSC3D.Viewer.prototype.renderMode="flat";JSC3D.Viewer.prototype.definition="standard";JSC3D.Viewer.prototype.isMipMappingOn=false;JSC3D.Viewer.prototype.creaseAngle=-180;JSC3D.Viewer.prototype.sphereMapUrl="";JSC3D.Viewer.prototype.showProgressBar=true;JSC3D.Viewer.prototype.buttonStates=null;JSC3D.Viewer.prototype.keyStates=null;JSC3D.Viewer.prototype.mouseX=0;JSC3D.Viewer.prototype.mouseY=0;JSC3D.Viewer.prototype.onloadingstarted=null;JSC3D.Viewer.prototype.onloadingcomplete=null;JSC3D.Viewer.prototype.onloadingprogress=null;JSC3D.Viewer.prototype.onloadingaborted=null;JSC3D.Viewer.prototype.onloadingerror=null;JSC3D.Viewer.prototype.onmousedown=null;JSC3D.Viewer.prototype.onmouseup=null;JSC3D.Viewer.prototype.onmousemove=null;JSC3D.Viewer.prototype.onmousewheel=null;JSC3D.Viewer.prototype.onmouseclick=null;JSC3D.Viewer.prototype.beforeupdate=null;JSC3D.Viewer.prototype.afterupdate=null;JSC3D.Viewer.prototype.mouseUsage="default";JSC3D.Viewer.prototype.isDefaultInputHandlerEnabled=false;JSC3D.PickInfo=function(){this.canvasX=0;this.canvasY=0;this.depth=-Infinity;this.mesh=null};JSC3D.Scene=function(e){this.name=e||"";this.aabb=null;this.children=[];this.maxChildId=1};JSC3D.Scene.prototype.init=function(){if(this.isEmpty())return;for(var e=0;e<this.children.length;e++)this.children[e].init();if(!this.aabb){this.aabb=new JSC3D.AABB;this.calcAABB()}};JSC3D.Scene.prototype.isEmpty=function(){return this.children.length==0};JSC3D.Scene.prototype.addChild=function(e){e.internalId=this.maxChildId++;this.children.push(e)};JSC3D.Scene.prototype.removeChild=function(e){var t=this.children.indexOf(e);if(t>=0)this.children.splice(t,1)};JSC3D.Scene.prototype.getChildren=function(){return this.children.slice(0)};JSC3D.Scene.prototype.forEachChild=function(e){if(typeof e!="function")return;for(var t=0;t<this.children.length;t++){if(e.call(null,this.children[t]))break}};JSC3D.Scene.prototype.calcAABB=function(){this.aabb.minX=this.aabb.minY=this.aabb.minZ=Infinity;this.aabb.maxX=this.aabb.maxY=this.aabb.maxZ=-Infinity;for(var e=0;e<this.children.length;e++){var t=this.children[e];if(!t.isTrivial()){var n=t.aabb.minX;var r=t.aabb.minY;var i=t.aabb.minZ;var s=t.aabb.maxX;var o=t.aabb.maxY;var u=t.aabb.maxZ;if(this.aabb.minX>n)this.aabb.minX=n;if(this.aabb.minY>r)this.aabb.minY=r;if(this.aabb.minZ>i)this.aabb.minZ=i;if(this.aabb.maxX<s)this.aabb.maxX=s;if(this.aabb.maxY<o)this.aabb.maxY=o;if(this.aabb.maxZ<u)this.aabb.maxZ=u}}};JSC3D.Scene.prototype.name="";JSC3D.Scene.prototype.aabb=null;JSC3D.Scene.prototype.children=null;JSC3D.Scene.prototype.maxChildId=1;JSC3D.Mesh=function(e,t,n,r,i,s,o,u,a,f,l){this.name=e||"";this.metadata="";this.visible=t!=undefined?t:true;this.renderMode=null;this.aabb=null;this.vertexBuffer=u||null;this.indexBuffer=a||null;this.vertexNormalBuffer=null;this.vertexNormalIndexBuffer=null;this.faceNormalBuffer=null;this.material=n||null;this.texture=r||null;this.faceCount=0;this.creaseAngle=i>=0?i:-180;this.isDoubleSided=s||false;this.isEnvironmentCast=o||false;this.internalId=0;this.texCoordBuffer=f||null;this.texCoordIndexBuffer=l||null;this.transformedVertexBuffer=null;this.transformedVertexNormalZBuffer=null;this.transformedFaceNormalZBuffer=null;this.transformedVertexNormalBuffer=null};JSC3D.Mesh.prototype.init=function(){if(this.isTrivial()){return}if(this.faceCount==0){this.calcFaceCount();if(this.faceCount==0)return}if(!this.aabb){this.aabb=new JSC3D.AABB;this.calcAABB()}if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals()}if(!this.vertexNormalBuffer){if(this.creaseAngle>=0){this.calcCreasedVertexNormals()}else{this.vertexNormalBuffer=new Array(this.vertexBuffer.length);this.calcVertexNormals()}}this.normalizeFaceNormals();this.transformedVertexBuffer=new Array(this.vertexBuffer.length)};JSC3D.Mesh.prototype.isTrivial=function(){return!this.vertexBuffer||this.vertexBuffer.length<3||!this.indexBuffer||this.indexBuffer.length<3};JSC3D.Mesh.prototype.setMaterial=function(e){this.material=e};JSC3D.Mesh.prototype.setTexture=function(e){this.texture=e};JSC3D.Mesh.prototype.hasTexture=function(){return this.texture!=null&&this.texture.hasData()&&this.texCoordBuffer!=null&&this.texCoordBuffer.length>=2&&(this.texCoordIndexBuffer==null||this.texCoordIndexBuffer.length>=3&&this.texCoordIndexBuffer.length>=this.indexBuffer.length)};JSC3D.Mesh.prototype.setRenderMode=function(e){this.renderMode=e};JSC3D.Mesh.prototype.calcFaceCount=function(){this.faceCount=0;var e=this.indexBuffer;if(e[e.length-1]!=-1)e.push(-1);for(var t=0;t<e.length;t++){if(e[t]==-1)this.faceCount++}};JSC3D.Mesh.prototype.calcAABB=function(){var e=minY=minZ=Infinity;var t=maxY=maxZ=-Infinity;var n=this.vertexBuffer;for(var r=0;r<n.length;r+=3){var i=n[r];var s=n[r+1];var o=n[r+2];if(i<e)e=i;if(i>t)t=i;if(s<minY)minY=s;if(s>maxY)maxY=s;if(o<minZ)minZ=o;if(o>maxZ)maxZ=o}this.aabb.minX=e;this.aabb.minY=minY;this.aabb.minZ=minZ;this.aabb.maxX=t;this.aabb.maxY=maxY;this.aabb.maxZ=maxZ};JSC3D.Mesh.prototype.calcFaceNormals=function(){var e=this.vertexBuffer;var t=this.indexBuffer;var n=this.faceNormalBuffer;var r=0,i=0;while(r<t.length){var s=t[r++]*3;var o=e[s];var u=e[s+1];var a=e[s+2];s=t[r++]*3;var f=e[s];var l=e[s+1];var c=e[s+2];s=t[r++]*3;var h=e[s];var p=e[s+1];var d=e[s+2];var v=f-o;var m=l-u;var g=c-a;var y=h-o;var b=p-u;var w=d-a;var E=m*w-g*b;var S=g*y-v*w;var x=v*b-m*y;n[i++]=E;n[i++]=S;n[i++]=x;do{}while(t[r++]!=-1)}};JSC3D.Mesh.prototype.normalizeFaceNormals=function(){JSC3D.Math3D.normalizeVectors(this.faceNormalBuffer,this.faceNormalBuffer)};JSC3D.Mesh.prototype.calcVertexNormals=function(){if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals()}var e=this.vertexBuffer;var t=this.indexBuffer;var n=this.faceNormalBuffer;var r=this.vertexNormalBuffer;for(var i=0;i<r.length;i++){r[i]=0}this.vertexNormalIndexBuffer=null;var s=e.length/3;var i=0,o=0,u=0;while(i<t.length){u=t[i++];if(u==-1){o+=3}else{var a=u*3;r[a]+=n[o];r[a+1]+=n[o+1];r[a+2]+=n[o+2]}}JSC3D.Math3D.normalizeVectors(r,r)};JSC3D.Mesh.prototype.calcCreasedVertexNormals=function(){if(!this.faceNormalBuffer){this.faceNormalBuffer=new Array(this.faceCount*3);this.calcFaceNormals()}var e=this.indexBuffer;var t=this.vertexBuffer.length/3;var n=new Array(t);var r=0;for(var i=0,s=0,o=0;i<e.length;i++){o=e[i];if(o>=0){r+=3;var u=n[o];if(!u)n[o]=[s];else u.push(s)}else{s++}}var a=this.faceNormalBuffer;var f=new Array(a.length);JSC3D.Math3D.normalizeVectors(a,f);if(!this.vertexNormalBuffer||this.vertexNormalBuffer.length<r)this.vertexNormalBuffer=new Array(r);var l=this.vertexNormalBuffer;for(var i=0;i<l.length;i++){l[i]=0}this.vertexNormalIndexBuffer=[];var c=this.vertexNormalIndexBuffer;var h=Math.cos(this.creaseAngle*Math.PI/180);for(var i=0,o=0,p=0,d=0;i<e.length;i++){o=e[i];if(o>=0){var v=p*3;var m=d*3;l[v]+=a[m];l[v+1]+=a[m+1];l[v+2]+=a[m+2];var g=f[m];var y=f[m+1];var b=f[m+2];var u=n[o];for(var w=0;w<u.length;w++){var E=u[w];if(d!=E){var S=E*3;var x=f[S];var T=f[S+1];var N=f[S+2];if(g*x+y*T+b*N>h){l[v]+=a[S];l[v+1]+=a[S+1];l[v+2]+=a[S+2]}}}c.push(p++)}else{d++;c.push(-1)}}JSC3D.Math3D.normalizeVectors(l,l)};JSC3D.Mesh.prototype.checkValid=function(){};JSC3D.Mesh.prototype.name="";JSC3D.Mesh.prototype.metadata="";JSC3D.Mesh.prototype.visible=false;JSC3D.Mesh.prototype.renderMode="flat";JSC3D.Mesh.prototype.aabb=null;JSC3D.Mesh.prototype.vertexBuffer=null;JSC3D.Mesh.prototype.indexBuffer=null;JSC3D.Mesh.prototype.vertexNormalBuffer=null;JSC3D.Mesh.prototype.vertexNormalIndexBuffer=null;JSC3D.Mesh.prototype.faceNormalBuffer=null;JSC3D.Mesh.prototype.texCoordBuffer=null;JSC3D.Mesh.prototype.texCoordIndexBuffer=null;JSC3D.Mesh.prototype.material=null;JSC3D.Mesh.prototype.texture=null;JSC3D.Mesh.prototype.faceCount=0;JSC3D.Mesh.prototype.creaseAngle=-180;JSC3D.Mesh.prototype.isDoubleSided=false;JSC3D.Mesh.prototype.isEnvironmentCast=false;JSC3D.Mesh.prototype.internalId=0;JSC3D.Mesh.prototype.transformedVertexBuffer=null;JSC3D.Mesh.prototype.transformedVertexNormalZBuffer=null;JSC3D.Mesh.prototype.transformedFaceNormalZBuffer=null;JSC3D.Mesh.prototype.transformedVertexNormalBuffer=null;JSC3D.Material=function(e,t,n,r,i){this.name=e||"";this.diffuseColor=n||8355711;this.ambientColor=typeof t=="number"?t:(this.diffuseColor&16711680)>>3&16711680|(this.diffuseColor&65280)>>3&65280|(this.diffuseColor&255)>>3;this.transparency=r||0;this.simulateSpecular=i||false;this.palette=null};JSC3D.Material.prototype.getPalette=function(){if(!this.palette){this.palette=new Array(256);this.generatePalette()}return this.palette};JSC3D.Material.prototype.generatePalette=function(){var e=(this.ambientColor&16711680)>>16;var t=(this.ambientColor&65280)>>8;var n=this.ambientColor&255;var r=(this.diffuseColor&16711680)>>16;var i=(this.diffuseColor&65280)>>8;var s=this.diffuseColor&255;if(this.simulateSpecular){var o=0;while(o<204){var u=Math.max(e,o*r/204);var a=Math.max(t,o*i/204);var f=Math.max(n,o*s/204);if(u>255)u=255;if(a>255)a=255;if(f>255)f=255;this.palette[o++]=u<<16|a<<8|f}while(o<256){var u=Math.max(e,r+(o-204)*(255-r)/82);var a=Math.max(t,i+(o-204)*(255-i)/82);var f=Math.max(n,s+(o-204)*(255-s)/82);if(u>255)u=255;if(a>255)a=255;if(f>255)f=255;this.palette[o++]=u<<16|a<<8|f}}else{var o=0;while(o<256){var u=Math.max(e,o*r/256);var a=Math.max(t,o*i/256);var f=Math.max(n,o*s/256);if(u>255)u=255;if(a>255)a=255;if(f>255)f=255;this.palette[o++]=u<<16|a<<8|f}}};JSC3D.Material.prototype.name="";JSC3D.Material.prototype.ambientColor=0;JSC3D.Material.prototype.diffuseColor=8355711;JSC3D.Material.prototype.transparency=0;JSC3D.Material.prototype.simulateSpecular=false;JSC3D.Material.prototype.palette=null;JSC3D.Texture=function(e,t){this.name=e||"";this.width=0;this.height=0;this.data=null;this.mipmaps=null;this.mipentries=null;this.hasTransparency=false;this.srcUrl="";this.onready=t&&typeof t=="function"?t:null};JSC3D.Texture.prototype.createFromUrl=function(e,t){var n=this;var r=new Image;r.onload=function(){n.data=null;n.mipmaps=null;n.mipentries=null;n.width=0;n.height=0;n.hasTransparency=false;n.srcUrl="";n.createFromImage(this,t);if(JSC3D.console)JSC3D.console.logInfo('Finished loading texture image file "'+this.src+'".')};r.onerror=function(){n.data=null;n.mipmaps=null;n.mipentries=null;n.width=0;n.height=0;n.hasTransparency=false;n.srcUrl="";if(JSC3D.console)JSC3D.console.logWarning('Failed to load texture image file "'+this.src+'". This texture will be discarded.')};r.crossOrigin="anonymous";r.src=encodeURI(e)};JSC3D.Texture.prototype.createFromImage=function(e,t){if(e.width<=0||e.height<=0)return;var n=false;var r=JSC3D.Texture.cv;if(!r){try{r=document.createElement("canvas");JSC3D.Texture.cv=r;n=true}catch(i){return}}var s=e.width>e.height?e.width:e.height;if(s<=16)s=16;else if(s<=32)s=32;else if(s<=64)s=64;else if(s<=128)s=128;else if(s<=256)s=256;else if(s<=512)s=512;else s=1024;if(r.width!=s||r.height!=s){r.width=r.height=s;n=true}var o;try{var u=r.getContext("2d");if(!n)u.clearRect(0,0,s,s);u.drawImage(e,0,0,s,s);var a=u.getImageData(0,0,s,s);o=a.data}catch(i){return}var f=o.length/4;this.data=new Array(f);var l;for(var c=0,h=0;c<f;c++,h+=4){l=o[h+3];this.data[c]=l<<24|o[h]<<16|o[h+1]<<8|o[h+2];if(l<255)this.hasTransparency=true}this.width=s;this.height=s;this.mipmaps=null;if(t)this.generateMipmaps();this.srcUrl=e.src;if(this.onready!=null&&typeof this.onready=="function")this.onready()};JSC3D.Texture.prototype.hasData=function(){return this.data!=null};JSC3D.Texture.prototype.generateMipmaps=function(){if(this.width<=1||this.data==null||this.mipmaps!=null)return;this.mipmaps=[this.data];this.mipentries=[1];var e=1+~~(.1+Math.log(this.width)*Math.LOG2E);var t=this.width>>1;for(var n=1;n<e;n++){var r=new Array(t*t);var i=this.mipmaps[n-1];var s=t<<1;var o=0,u=0;for(var a=0;a<t;a++){for(var f=0;f<t;f++){var l=i[o];var c=i[o+1];var h=i[o+s];var p=i[o+s+1];var d=((l&4278190080)>>>2)+((c&4278190080)>>>2)+((h&4278190080)>>>2)+((p&4278190080)>>>2)&4278190080;var v=(l&16711680)+(c&16711680)+(h&16711680)+(p&16711680)>>2&16711680;var m=(l&65280)+(c&65280)+(h&65280)+(p&65280)>>2&65280;var g=(l&255)+(c&255)+(h&255)+(p&255)>>2&255;r[u]=d+v+m+g;o+=2;u++}o+=s}this.mipmaps.push(r);this.mipentries.push(Math.pow(4,n));t=t>>1}};JSC3D.Texture.prototype.hasMipmap=function(){return this.mipmaps!=null};JSC3D.Texture.prototype.name="";JSC3D.Texture.prototype.data=null;JSC3D.Texture.prototype.mipmaps=null;JSC3D.Texture.prototype.mipentries=null;JSC3D.Texture.prototype.width=0;JSC3D.Texture.prototype.height=0;JSC3D.Texture.prototype.hasTransparency=false;JSC3D.Texture.prototype.srcUrl="";JSC3D.Texture.prototype.onready=null;JSC3D.Texture.cv=null;JSC3D.AABB=function(){this.minX=0;this.minY=0;this.minZ=0;this.maxX=0;this.maxY=0;this.maxZ=0};JSC3D.AABB.prototype.center=function(e){if(e){e[0]=.5*(this.minX+this.maxX);e[1]=.5*(this.minY+this.maxY);e[2]=.5*(this.minZ+this.maxZ)}else e=[.5*(this.minX+this.maxX),.5*(this.minY+this.maxY),.5*(this.minZ+this.maxZ)];return e};JSC3D.AABB.prototype.lengthOfDiagonal=function(){var e=this.maxX-this.minX;var t=this.maxY-this.minY;var n=this.maxZ-this.minZ;return Math.sqrt(e*e+t*t+n*n)};JSC3D.Matrix3x4=function(){this.m00=1;this.m01=0;this.m02=0;this.m03=0;this.m10=0;this.m11=1;this.m12=0;this.m13=0;this.m20=0;this.m21=0;this.m22=1;this.m23=0};JSC3D.Matrix3x4.prototype.identity=function(){this.m00=1;this.m01=0;this.m02=0;this.m03=0;this.m10=0;this.m11=1;this.m12=0;this.m13=0;this.m20=0;this.m21=0;this.m22=1;this.m23=0};JSC3D.Matrix3x4.prototype.scale=function(e,t,n){this.m00*=e;this.m01*=e;this.m02*=e;this.m03*=e;this.m10*=t;this.m11*=t;this.m12*=t;this.m13*=t;this.m20*=n;this.m21*=n;this.m22*=n;this.m23*=n};JSC3D.Matrix3x4.prototype.translate=function(e,t,n){this.m03+=e;this.m13+=t;this.m23+=n};JSC3D.Matrix3x4.prototype.rotateAboutXAxis=function(e){if(e!=0){e*=Math.PI/180;var t=Math.cos(e);var n=Math.sin(e);var r=t*this.m10-n*this.m20;var i=t*this.m11-n*this.m21;var s=t*this.m12-n*this.m22;var o=t*this.m13-n*this.m23;var u=t*this.m20+n*this.m10;var a=t*this.m21+n*this.m11;var f=t*this.m22+n*this.m12;var l=t*this.m23+n*this.m13;this.m10=r;this.m11=i;this.m12=s;this.m13=o;this.m20=u;this.m21=a;this.m22=f;this.m23=l}};JSC3D.Matrix3x4.prototype.rotateAboutYAxis=function(e){if(e!=0){e*=Math.PI/180;var t=Math.cos(e);var n=Math.sin(e);var r=t*this.m00+n*this.m20;var i=t*this.m01+n*this.m21;var s=t*this.m02+n*this.m22;var o=t*this.m03+n*this.m23;var u=t*this.m20-n*this.m00;var a=t*this.m21-n*this.m01;var f=t*this.m22-n*this.m02;var l=t*this.m23-n*this.m03;this.m00=r;this.m01=i;this.m02=s;this.m03=o;this.m20=u;this.m21=a;this.m22=f;this.m23=l}};JSC3D.Matrix3x4.prototype.rotateAboutZAxis=function(e){if(e!=0){e*=Math.PI/180;var t=Math.cos(e);var n=Math.sin(e);var r=t*this.m10+n*this.m00;var i=t*this.m11+n*this.m01;var s=t*this.m12+n*this.m02;var o=t*this.m13+n*this.m03;var u=t*this.m00-n*this.m10;var a=t*this.m01-n*this.m11;var f=t*this.m02-n*this.m12;var l=t*this.m03-n*this.m13;this.m00=u;this.m01=a;this.m02=f;this.m03=l;this.m10=r;this.m11=i;this.m12=s;this.m13=o}};JSC3D.Matrix3x4.prototype.multiply=function(e){var t=e.m00*this.m00+e.m01*this.m10+e.m02*this.m20;var n=e.m00*this.m01+e.m01*this.m11+e.m02*this.m21;var r=e.m00*this.m02+e.m01*this.m12+e.m02*this.m22;var i=e.m00*this.m03+e.m01*this.m13+e.m02*this.m23+e.m03;var s=e.m10*this.m00+e.m11*this.m10+e.m12*this.m20;var o=e.m10*this.m01+e.m11*this.m11+e.m12*this.m21;var u=e.m10*this.m02+e.m11*this.m12+e.m12*this.m22;var a=e.m10*this.m03+e.m11*this.m13+e.m12*this.m23+e.m13;var f=e.m20*this.m00+e.m21*this.m10+e.m22*this.m20;var l=e.m20*this.m01+e.m21*this.m11+e.m22*this.m21;var c=e.m20*this.m02+e.m21*this.m12+e.m22*this.m22;var h=e.m20*this.m03+e.m21*this.m13+e.m22*this.m23+e.m23;this.m00=t;this.m01=n;this.m02=r;this.m03=i;this.m10=s;this.m11=o;this.m12=u;this.m13=a;this.m20=f;this.m21=l;this.m22=c;this.m23=h};JSC3D.Math3D={transformVectors:function(e,t,n){for(var r=0;r<t.length;r+=3){var i=t[r];var s=t[r+1];var o=t[r+2];n[r]=e.m00*i+e.m01*s+e.m02*o+e.m03;n[r+1]=e.m10*i+e.m11*s+e.m12*o+e.m13;n[r+2]=e.m20*i+e.m21*s+e.m22*o+e.m23}},transformVectorZs:function(e,t,n){var r=t.length/3;var i=0,s=0;while(i<r){n[i]=e.m20*t[s]+e.m21*t[s+1]+e.m22*t[s+2]+e.m23;i++;s+=3}},normalizeVectors:function(e,t){var n=e.length;for(var r=0;r<n;r+=3){var i=e[r];var s=e[r+1];var o=e[r+2];var u=Math.sqrt(i*i+s*s+o*o);if(u>0){u=1/u;i*=u;s*=u;o*=u}t[r]=i;t[r+1]=s;t[r+2]=o}}};JSC3D.Util={ieXHRResponseBodyToString:function(e){var t=(new VBArray(e)).toArray();var n="";for(var r=0;r<t.length-65536;r+=65536)n+=String.fromCharCode.apply(null,t.slice(r,r+65536));return n+String.fromCharCode.apply(null,t.slice(r))}};JSC3D.PlatformInfo=function(){var e={browser:"other",version:"n/a",isTouchDevice:document.createTouch!=undefined,supportTypedArrays:window.Uint32Array!=undefined,supportWebGL:window.WebGLRenderingContext!=undefined};var t=[["firefox",/Firefox[\/\s](\d+(?:\.\d+)*)/],["chrome",/Chrome[\/\s](\d+(?:\.\d+)*)/],["opera",/Opera[\/\s](\d+(?:\.\d+)*)/],["safari",/Safari[\/\s](\d+(?:\.\d+)*)/],["webkit",/AppleWebKit[\/\s](\d+(?:\.\d+)*)/],["ie",/MSIE[\/\s](\d+(?:\.\d+)*)/],["ie",/Trident\/\d+\.\d+;\s.*rv:(\d+(?:\.\d+)*)/]];var n;for(var r=0;r<t.length;r++){if(n=t[r][1].exec(window.navigator.userAgent)){e.browser=t[r][0];e.version=n[1];break}}return e}();JSC3D.BinaryStream=function(e,t){if(t)throw"JSC3D.BinaryStream constructor failed: Big endian is not supported yet!";this.data=e;this.offset=0};JSC3D.BinaryStream.prototype.size=function(){return this.data.length};JSC3D.BinaryStream.prototype.tell=function(){return this.offset};JSC3D.BinaryStream.prototype.seek=function(e){if(e<0||e>=this.data.length)return false;this.offset=e;return true};JSC3D.BinaryStream.prototype.reset=function(){this.offset=0};JSC3D.BinaryStream.prototype.skip=function(e){if(this.offset+e>this.data.length)this.offset=this.data.length;else this.offset+=e};JSC3D.BinaryStream.prototype.available=function(){return this.data.length-this.offset};JSC3D.BinaryStream.prototype.eof=function(){return!(this.offset<this.data.length)};JSC3D.BinaryStream.prototype.readUInt8=function(){return this.decodeInt(1,false)};JSC3D.BinaryStream.prototype.readInt8=function(){return this.decodeInt(1,true)};JSC3D.BinaryStream.prototype.readUInt16=function(){return this.decodeInt(2,false)};JSC3D.BinaryStream.prototype.readInt16=function(){return this.decodeInt(2,true)};JSC3D.BinaryStream.prototype.readUInt32=function(){return this.decodeInt(4,false)};JSC3D.BinaryStream.prototype.readInt32=function(){return this.decodeInt(4,true)};JSC3D.BinaryStream.prototype.readFloat32=function(){return this.decodeFloat(4,23)};JSC3D.BinaryStream.prototype.readFloat64=function(){return this.decodeFloat(8,52)};JSC3D.BinaryStream.prototype.readBytes=function(e,t){var n=t;if(this.offset+t>this.data.length)n=this.data.length-this.offset;for(var r=0;r<n;r++){e[r]=this.data[this.offset++].charCodeAt(0)&255}return n};JSC3D.BinaryStream.prototype.decodeInt=function(e,t){if(this.offset+e>this.data.length){this.offset=this.data.length;return NaN}var n=0,r=1;for(var i=0;i<e;i++){n+=(this.data[this.offset++].charCodeAt(0)&255)*r;r*=256}if(t&&n&Math.pow(2,e*8-1))n-=Math.pow(2,e*8);return n};JSC3D.BinaryStream.prototype.decodeFloat=function(e,t){if(this.offset+e>this.data.length){this.offset=this.data.length;return NaN}var n=t;var r=e*8-n-1;var i=(1<<r)-1;var s=i>>1;var o=e-1;var u=-1;var a=this.data[this.offset+o].charCodeAt(0)&255;o+=u;var f=-7;var l=a&(1<<-f)-1;a>>=-f;f+=r;while(f>0){l=l*256+(this.data[this.offset+o].charCodeAt(0)&255);o+=u;f-=8}var c=l&(1<<-f)-1;l>>=-f;f+=n;while(f>0){c=c*256+(this.data[this.offset+o].charCodeAt(0)&255);o+=u;f-=8}this.offset+=e;switch(l){case 0:l=1-s;break;case i:return c?NaN:(a?-1:1)*Infinity;default:c+=Math.pow(2,n);l-=s;break}return(a?-1:1)*c*Math.pow(2,l-n)};JSC3D.LoaderSelector={registerLoader:function(e,t){if(typeof t=="function"){JSC3D.LoaderSelector.loaderTable[e]=t}},getLoader:function(e){var t=JSC3D.LoaderSelector.loaderTable[e.toLowerCase()];if(!t)return null;var n;try{n=new t}catch(r){n=null}return n},loaderTable:{}};JSC3D.ObjLoader=function(e,t,n,r){this.onload=e&&typeof e=="function"?e:null;this.onerror=t&&typeof t=="function"?t:null;this.onprogress=n&&typeof n=="function"?n:null;this.onresource=r&&typeof r=="function"?r:null;this.requestCount=0;this.requests=[]};JSC3D.ObjLoader.prototype.loadFromUrl=function(e){var t="";var n=e;var r=e.lastIndexOf("/");if(r==-1)r=e.lastIndexOf("\\");if(r!=-1){t=e.substring(0,r+1);n=e.substring(r+1)}this.requestCount=0;this.loadObjFile(t,n)};JSC3D.ObjLoader.prototype.abort=function(){for(var e=0;e<this.requests.length;e++){this.requests[e].abort()}this.requests=[];this.requestCount=0};JSC3D.ObjLoader.prototype.loadObjFile=function(e,t){var n=e+t;var r=this;var i=new XMLHttpRequest;i.open("GET",encodeURI(n),true);i.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){if(r.onload){if(r.onprogress)r.onprogress("Loading obj file ...",1);if(JSC3D.console)JSC3D.console.logInfo('Finished loading obj file "'+n+'".');var t=new JSC3D.Scene;var i=r.parseObj(t,this.responseText);if(i.length>0){for(var s=0;s<i.length;s++)r.loadMtlFile(t,e,i[s])}r.requests.splice(r.requests.indexOf(this),1);if(--r.requestCount==0)r.onload(t)}}else{r.requests.splice(r.requests.indexOf(this),1);r.requestCount--;if(JSC3D.console)JSC3D.console.logError('Failed to load obj file "'+n+'".');if(r.onerror)r.onerror('Failed to load obj file "'+n+'".')}}};if(this.onprogress){this.onprogress("Loading obj file ...",0);i.onprogress=function(e){r.onprogress("Loading obj file ...",e.position/e.totalSize)}}this.requests.push(i);this.requestCount++;i.send()};JSC3D.ObjLoader.prototype.loadMtlFile=function(e,t,n){var r=t+n;var i=this;var s=new XMLHttpRequest;s.open("GET",encodeURI(r),true);s.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){if(i.onprogress)i.onprogress("Loading mtl file ...",1);if(JSC3D.console)JSC3D.console.logInfo('Finished loading mtl file "'+r+'".');var s=i.parseMtl(this.responseText);var o={};var u=e.getChildren();for(var a=0;a<u.length;a++){var f=u[a];if(f.mtl!=null&&f.mtllib!=null&&f.mtllib==n){var l=s[f.mtl];if(l!=null){if(l.material!=null)f.setMaterial(l.material);if(l.textureFileName!=""){if(!o[l.textureFileName])o[l.textureFileName]=[f];else o[l.textureFileName].push(f)}}}}for(var c in o)i.setupTexture(o[c],t+c)}else{if(JSC3D.console)JSC3D.console.logWarning('Failed to load mtl file "'+r+'". A default material will be applied.')}i.requests.splice(i.requests.indexOf(this),1);if(--i.requestCount==0)i.onload(e)}};if(this.onprogress){this.onprogress("Loading mtl file ...",0);s.onprogress=function(e){i.onprogress("Loading mtl file ...",e.position/e.totalSize)}}this.requests.push(s);this.requestCount++;s.send()};JSC3D.ObjLoader.prototype.parseObj=function(e,t){var n={};var r=[];var i="obj-";var s=0;var o=null;var u="";var a="";var f=[];var l=[];var c=i+s++;var h=new JSC3D.Mesh;h.name=c;h.indexBuffer=[];n["nomtl"]=h;o=h;var p=t.split(/[ \t]*\r?\n[ \t]*/);for(var d=0;d<p.length;d++){var v=p[d];var m=v.split(/[ \t]+/);if(m.length>0){var g=m[0];switch(g){case"v":if(m.length>3){for(var y=1;y<4;y++){f.push(parseFloat(m[y]))}}break;case"vn":break;case"vt":if(m.length>2){l.push(parseFloat(m[1]));l.push(1-parseFloat(m[2]))}break;case"f":if(m.length>3){for(var y=1;y<m.length;y++){var b=m[y].split("/");var w=parseInt(b[0])-1;o.indexBuffer.push(w);if(b.length>1){if(b[1]!=""){if(!o.texCoordIndexBuffer)o.texCoordIndexBuffer=[];o.texCoordIndexBuffer.push(parseInt(b[1])-1)}else if(b.length<3||b[2]==""){if(!o.texCoordIndexBuffer)o.texCoordIndexBuffer=[];o.texCoordIndexBuffer.push(w)}}}o.indexBuffer.push(-1);if(o.texCoordIndexBuffer)o.texCoordIndexBuffer.push(-1)}break;case"mtllib":if(m.length>1){u=m[1];r.push(u)}else u="";break;case"usemtl":if(m.length>1&&m[1]!=""&&u!=""){a=m[1];var E=u+"-"+a;var S=n[E];if(!S){S=new JSC3D.Mesh;S.name=i+s++;S.indexBuffer=[];S.mtllib=u;S.mtl=a;n[E]=S}o=S}else{a="";o=h}break;case"#":default:break}}}var x=f.length>=3?new Array(f.length/3):null;var T=l.length>=2?new Array(l.length/2):null;for(var N in n){var S=n[N];if(f.length>=3&&S.indexBuffer.length>0){for(var d=0;d<x.length;d++)x[d]=-1;S.vertexBuffer=[];var C=0,k=0;for(var d=0;d<S.indexBuffer.length;d++){C=S.indexBuffer[d];if(C!=-1){if(x[C]==-1){var L=C*3;S.vertexBuffer.push(f[L]);S.vertexBuffer.push(f[L+1]);S.vertexBuffer.push(f[L+2]);S.indexBuffer[d]=k;x[C]=k;k++}else{S.indexBuffer[d]=x[C]}}}}if(l.length>=2&&S.texCoordIndexBuffer!=null&&S.texCoordIndexBuffer.length>0){for(var d=0;d<T.length;d++)T[d]=-1;S.texCoordBuffer=[];var A=0,O=0;for(var d=0;d<S.texCoordIndexBuffer.length;d++){A=S.texCoordIndexBuffer[d];if(A!=-1){if(T[A]==-1){var M=A*2;S.texCoordBuffer.push(l[M]);S.texCoordBuffer.push(l[M+1]);S.texCoordIndexBuffer[d]=O;T[A]=O;O++}else{S.texCoordIndexBuffer[d]=T[A]}}}}if(!S.isTrivial())e.addChild(S)}return r};JSC3D.ObjLoader.prototype.parseMtl=function(e){var t={};var n="";var r=e.split(/[ \t]*\r?\n[ \t]*/);for(var i=0;i<r.length;i++){var s=r[i];var o=s.split(/[ \t]+/);if(o.length>0){var u=o[0];switch(u){case"newmtl":n=o[1];var a={};a.material=new JSC3D.Material;a.material.name=n;a.textureFileName="";t[n]=a;break;case"Ka":case"ka":break;case"Kd":case"kd":if(o.length==4&&!isNaN(o[1])){var f=parseFloat(o[1])*255&255;var l=parseFloat(o[2])*255&255;var c=parseFloat(o[3])*255&255;var a=t[n];if(a!=null)a.material.diffuseColor=f<<16|l<<8|c}break;case"Ks":case"ks":break;case"d":if(o.length==2&&!isNaN(o[1])){var h=parseFloat(o[1]);var a=t[n];if(a!=null)a.material.transparency=1-h}break;case"illum":break;case"map_Kd":case"map_kd":if(o.length==2){var p=o[1];var a=t[n];if(a!=null)a.textureFileName=p}break;case"#":default:break}}}return t};JSC3D.ObjLoader.prototype.setupTexture=function(e,t){var n=this;var r=new JSC3D.Texture;r.onready=function(){for(var t=0;t<e.length;t++)e[t].setTexture(this);if(n.onresource)n.onresource(this)};r.createFromUrl(t)};JSC3D.ObjLoader.prototype.onload=null;JSC3D.ObjLoader.prototype.onerror=null;JSC3D.ObjLoader.prototype.onprogress=null;JSC3D.ObjLoader.prototype.onresource=null;JSC3D.ObjLoader.prototype.requestCount=0;JSC3D.LoaderSelector.registerLoader("obj",JSC3D.ObjLoader);JSC3D.StlLoader=function(e,t,n,r){this.onload=e&&typeof e=="function"?e:null;this.onerror=t&&typeof t=="function"?t:null;this.onprogress=n&&typeof n=="function"?n:null;this.onresource=r&&typeof r=="function"?r:null;this.decimalPrecision=3;this.request=null};JSC3D.StlLoader.prototype.loadFromUrl=function(e){var t=this;var n=JSC3D.PlatformInfo.browser=="ie";var r=false;var i=new XMLHttpRequest;i.open("GET",encodeURI(e),true);if(r)i.responseType="blob";else if(n)i.setRequestHeader("Accept-Charset","x-user-defined");else i.overrideMimeType("text/plain; charset=x-user-defined");i.onreadystatechange=function(){if(this.readyState==4){if(this.status==200||this.status==0){if(JSC3D.console)JSC3D.console.logInfo('Finished loading STL file "'+e+'".');if(t.onload){if(t.onprogress)t.onprogress("Loading STL file ...",1);if(r){var i=new FileReader;i.onload=function(e){var n=new JSC3D.Scene;t.parseStl(n,e.target.result);t.onload(n)};i.readAsText(this.response,"x-user-defined")}else if(n){var s=new JSC3D.Scene;try{t.parseStl(s,JSC3D.Util.ieXHRResponseBodyToString(this.responseBody))}catch(o){}t.onload(s)}else{var s=new JSC3D.Scene;t.parseStl(s,this.responseText);t.onload(s)}}}else{if(JSC3D.console)JSC3D.console.logError('Failed to load STL file "'+e+'".');if(t.onerror)t.onerror('Failed to load STL file "'+e+'".')}t.request=null}};if(this.onprogress){this.onprogress("Loading STL file ...",0);i.onprogress=function(e){t.onprogress("Loading STL file ...",e.position/e.totalSize)}}this.request=i;i.send()};JSC3D.StlLoader.prototype.abort=function(){if(this.request){this.request.abort();this.request=null}};JSC3D.StlLoader.prototype.setDecimalPrecision=function(e){this.decimalPrecision=e};JSC3D.StlLoader.prototype.parseStl=function(e,t){var n=3;var r=80;var i=4;var s=12;var o=12;var u=2;var a=new JSC3D.Mesh;a.vertexBuffer=[];a.indexBuffer=[];a.faceNormalBuffer=[];var f=false;var l=new JSC3D.BinaryStream(t);l.skip(r+i);for(var c=0;c<256&&!l.eof();c++){if(l.readUInt8()>127){f=true;break}}if(JSC3D.console)JSC3D.console.logInfo("This is recognised as "+(f?"a binary":"an ASCII")+" STL file.");if(!f){var h="facet\\s+normal\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+"+"outer\\s+loop\\s+"+"vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+"+"vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+"+"vertex\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+([-+]?\\b(?:[0-9]*\\.)?[0-9]+(?:[eE][-+]?[0-9]+)?\\b)\\s+"+"endloop\\s+"+"endfacet";var p=new RegExp(h,"ig");var d=t.match(p);if(d){var v=d.length;a.faceCount=v;var m={};p.lastIndex=0;p.global=false;for(var g=p.exec(t);g!=null;g=p.exec(t)){a.faceNormalBuffer.push(parseFloat(g[1]),parseFloat(g[2]),parseFloat(g[3]));for(var c=0;c<n;c++){var y=parseFloat(g[4+c*3]);var b=parseFloat(g[5+c*3]);var w=parseFloat(g[6+c*3]);var E=y.toFixed(this.decimalPrecision)+"-"+b.toFixed(this.decimalPrecision)+"-"+w.toFixed(this.decimalPrecision);var S=m[E];if(S===undefined){S=a.vertexBuffer.length/3;m[E]=S;a.vertexBuffer.push(y);a.vertexBuffer.push(b);a.vertexBuffer.push(w)}a.indexBuffer.push(S)}a.indexBuffer.push(-1)}}}else{l.reset();l.skip(r);var v=l.readUInt32();var x=r+i+(s+o*n+u)*v;if(l.size()<x){if(JSC3D.console)JSC3D.console.logError("Failed to parse contents of the file. It seems not complete.");return}a.faceCount=v;var m={};for(var c=0;c<v;c++){a.faceNormalBuffer.push(l.readFloat32());a.faceNormalBuffer.push(l.readFloat32());a.faceNormalBuffer.push(l.readFloat32());for(var T=0;T<n;T++){var y,b,w;y=l.readFloat32();b=l.readFloat32();w=l.readFloat32();var E=y.toFixed(this.decimalPrecision)+"-"+b.toFixed(this.decimalPrecision)+"-"+w.toFixed(this.decimalPrecision);var S=m[E];if(S!=undefined){a.indexBuffer.push(S)}else{S=a.vertexBuffer.length/3;m[E]=S;a.vertexBuffer.push(y);a.vertexBuffer.push(b);a.vertexBuffer.push(w);a.indexBuffer.push(S)}}a.indexBuffer.push(-1);l.skip(u)}}if(!a.isTrivial()){if(Math.abs(a.faceNormalBuffer[0])<1e-6&&Math.abs(a.faceNormalBuffer[1])<1e-6&&Math.abs(a.faceNormalBuffer[2])<1e-6){a.faceNormalBuffer=null}e.addChild(a)}};JSC3D.StlLoader.prototype.onload=null;JSC3D.StlLoader.prototype.onerror=null;JSC3D.StlLoader.prototype.onprogress=null;JSC3D.StlLoader.prototype.onresource=null;JSC3D.StlLoader.prototype.decimalPrecision=3;JSC3D.LoaderSelector.registerLoader("stl",JSC3D.StlLoader)